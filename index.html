<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vui Th·ªÉ Thao - K·∫øt n·ªëi ƒëam m√™</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* === C√ÄI ƒê·∫∂T CHUNG (MODERN UI) === */
        :root {
            --primary: #2563eb;       /* Xanh d∆∞∆°ng hi·ªán ƒë·∫°i */
            --primary-dark: #1d4ed8;
            --secondary: #64748b;     /* X√°m xanh */
            --green: #10b981;         /* Xanh l√° t∆∞∆°i */
            --red: #ef4444;           /* ƒê·ªè */
            --bg: #f3f4f6;            /* N·ªÅn x√°m nh·∫°t */
            --white: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background: var(--bg); 
            margin: 0; 
            color: var(--text-main); 
            line-height: 1.5;
        }
        
        * { box-sizing: border-box; transition: all 0.2s ease; }

        /* === COMPONENTS === */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        
        button { 
            border: none; padding: 12px 20px; border-radius: 8px; 
            cursor: pointer; font-weight: 600; font-size: 14px; 
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        button:active { transform: scale(0.98); }

        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        
        .btn-success { background: var(--green); color: white; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2); }
        .btn-success:hover { filter: brightness(90%); transform: translateY(-1px); }
        
        .btn-danger { background: var(--red); color: white; }
        .btn-danger:hover { filter: brightness(90%); }

        .btn-block { width: 100%; }

        input, select, textarea { 
            width: 100%; padding: 12px 15px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            background: #f9fafb;
            font-family: inherit; font-size: 14px;
            color: var(--text-main);
            margin-bottom: 15px;
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; border-color: var(--primary); 
            background: white; 
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); 
        }
        label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; color: var(--text-main); }

        /* === LAYOUT === */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { 
            background: var(--white); padding: 25px; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow); 
            margin-bottom: 25px; 
            border: 1px solid rgba(0,0,0,0.02);
        }
        h3, h4, h5 { margin-top: 0; color: var(--text-main); }
        h3 { font-size: 1.5rem; margin-bottom: 20px; border-bottom: 2px solid var(--bg); padding-bottom: 10px; }

        /* === AUTH SCREEN === */
        #auth-container { 
            min-height: 100vh; display: flex; 
            align-items: center; justify-content: center; 
            background: linear-gradient(135deg, #e0f2fe 0%, #f3f4f6 100%);
        }
        .auth-box { 
            background: var(--white); padding: 40px; width: 100%; max-width: 450px; 
            border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); 
        }
        .auth-header h2 { color: var(--primary); margin-bottom: 5px; text-align: center; }
        .auth-header p { color: var(--text-light); text-align: center; margin-top: 0; margin-bottom: 30px; font-size: 0.9rem; }

        /* === NAVIGATION === */
        .top-nav { 
            background: var(--white); height: 70px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            position: sticky; top: 0; z-index: 50; 
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 30px;
        }
        .logo { font-size: 24px; font-weight: 800; color: var(--primary); letter-spacing: -1px; }
        .user-menu { display: flex; align-items: center; gap: 15px; }
        #welcomeMsg { font-weight: 600; color: var(--text-main); }

        /* === HERO SECTION === */
        .hero-header { 
            background: linear-gradient(rgba(15, 23, 42, 0.7), rgba(15, 23, 42, 0.7)), url('https://images.unsplash.com/photo-1542567431-031e403659e7?q=80'); 
            background-size: cover; background-position: center; 
            padding: 60px 20px; text-align: center; color: white; 
            margin-bottom: 30px;
        }
        .hero-header h1 { font-size: 2.5rem; margin-bottom: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        
        #playerSearchForm { 
            display: flex; flex-wrap: wrap; gap: 10px; 
            background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); 
            padding: 20px; border-radius: 12px; 
            max-width: 950px; margin: 0 auto; 
            border: 1px solid rgba(255,255,255,0.3);
        }
        #playerSearchForm input, #playerSearchForm select { margin: 0; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #playerSearchForm button { height: 45px; padding: 0 30px; font-size: 16px; }

        /* === TABS === */
        .tab-nav { 
            display: flex; background: var(--white); 
            border-radius: 12px; padding: 5px; 
            box-shadow: var(--shadow); margin-bottom: 30px;
        }
        .tab-btn { 
            flex: 1; padding: 12px; border-radius: 8px; 
            background: transparent; color: var(--text-light); 
            transition: all 0.3s;
        }
        .tab-btn:hover { background: #f3f4f6; color: var(--primary); }
        .tab-btn.active { background: var(--primary); color: white; shadow: 0 2px 4px rgba(37, 99, 235, 0.3); }
        
        .tab-content { display: none; animation: fadeEffect 0.4s; }
        @keyframes fadeEffect { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }
        .tab-content.active { display: block; }

        .sub-tabs { display: flex; gap: 10px; border-bottom: 2px solid var(--border); margin-bottom: 20px; padding-bottom: 10px; }
        .sub-tab-btn { 
            padding: 8px 16px; cursor: pointer; color: var(--text-light); 
            font-weight: 600; border-radius: 20px; 
        }
        .sub-tab-btn.active { background: #e0f2fe; color: var(--primary); }

        /* === LIST ITEMS (MATCHES, COURTS) === */
        .match-card, .court-result-item, .booking-item { 
            background: var(--white); border: 1px solid var(--border); 
            border-radius: 12px; padding: 20px; margin-bottom: 15px; 
            display: flex; align-items: center; gap: 20px; 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .match-card:hover, .court-result-item:hover { 
            transform: translateY(-3px); 
            box-shadow: var(--shadow-hover); 
            border-color: var(--primary);
        }
        
        .avatar { 
            width: 60px; height: 60px; background: #dbeafe; color: var(--primary); 
            border-radius: 12px; display: flex; align-items: center; justify-content: center; 
            font-size: 28px; flex-shrink: 0; 
        }
        .info-col { flex: 1; }
        .info-col h4 { margin: 0 0 5px; color: var(--text-main); font-size: 1.1rem; }
        .info-col p { margin: 2px 0; font-size: 0.9rem; color: var(--text-light); }
        
        .venue-item { 
            padding: 15px; border: 1px solid var(--border); 
            border-radius: 8px; margin-bottom: 8px; cursor: pointer; 
            background: #f9fafb;
        }
        .venue-item:hover { background: #fff; border-color: var(--primary); }
        .venue-item.active { background: #eff6ff; border-color: var(--primary); }

        /* === MODAL === */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal-content { background: var(--white); padding: 30px; border-radius: 16px; width: 90%; max-width: 550px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: slideUp 0.3s; }
        @keyframes slideUp { from {transform:translateY(50px); opacity:0} to {transform:translateY(0); opacity:1} }
        .close-modal { float: right; font-size: 28px; cursor: pointer; color: var(--text-light); }
        .close-modal:hover { color: var(--red); }
        
        .modal-info { background: #ecfdf5; border: 1px solid #a7f3d0; color: #065f46; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.95rem; line-height: 1.6; }

        /* === TOAST NOTIFICATION === */
        #messageArea { 
            position: fixed; bottom: 30px; right: 30px; 
            padding: 15px 25px; color: white; border-radius: 8px; 
            display: none; z-index: 9999; font-weight: 600; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            animation: slideInRight 0.3s;
        }
        @keyframes slideInRight { from {transform:translateX(100%)} to {transform:translateX(0)} }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
            #playerSearchForm { flex-direction: column; }
            .match-card, .court-result-item { flex-direction: column; align-items: flex-start; }
            .action-col { width: 100%; margin-top: 10px; display: flex; gap: 10px; }
            .tab-nav { flex-wrap: wrap; }
            .tab-btn { font-size: 13px; padding: 10px; }
            .hero-header h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>

    <div id="auth-container">
        <div id="login-card" class="auth-box">
            <div class="auth-header">
                <h2>Ch√†o M·ª´ng Tr·ªü L·∫°i!</h2>
                <p>ƒêƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c ƒëam m√™ th·ªÉ thao</p>
            </div>
            <form id="loginForm">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="name@example.com" required>
                <label>M·∫≠t kh·∫©u</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                <button type="submit" class="btn-primary btn-block">ƒêƒÉng Nh·∫≠p</button>
            </form>
            <p style="text-align:center; margin-top:20px; font-size:14px;">
                Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" onclick="toggleAuth()" style="color:var(--primary); text-decoration:none; font-weight:600">ƒêƒÉng k√Ω ngay</a>
            </p>
        </div>

        <div id="register-card" class="auth-box" style="display:none">
            <div class="auth-header">
                <h2>T·∫°o T√†i Kho·∫£n M·ªõi</h2>
                <p>Tham gia c·ªông ƒë·ªìng th·ªÉ thao ngay h√¥m nay</p>
            </div>
            <form id="registerForm">
                <label>T√™n hi·ªÉn th·ªã</label>
                <input type="text" id="regName" placeholder="V√≠ d·ª•: H√πng C·∫ßu L√¥ng" required>
                <label>Email</label>
                <input type="email" id="regEmail" placeholder="name@example.com" required>
                <label>M·∫≠t kh·∫©u</label>
                <input type="password" id="regPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                <label>B·∫°n l√† ai?</label>
                <select id="regRole">
                    <option value="player">Ng∆∞·ªùi ch∆°i (T√¨m s√¢n & Tham gia)</option>
                    <option value="owner">Ch·ªß s√¢n (Qu·∫£n l√Ω s√¢n b√£i)</option>
                </select>
                <button type="submit" class="btn-success btn-block">ƒêƒÉng K√Ω</button>
            </form>
            <p style="text-align:center; margin-top:20px; font-size:14px;">
                ƒê√£ c√≥ t√†i kho·∫£n? <a href="#" onclick="toggleAuth()" style="color:var(--primary); text-decoration:none; font-weight:600">ƒêƒÉng nh·∫≠p</a>
            </p>
        </div>
    </div>

    <div id="app-container" style="display:none">
        <nav class="top-nav">
            <div class="logo">VUI TH·ªÇ THAO</div>
            <div class="user-menu">
                <span id="welcomeMsg"></span>
                <button onclick="logout()" style="background:#f3f4f6; color:#374151">üö™ Tho√°t</button>
            </div>
        </nav>

        <header class="hero-header" id="hero-section">
            <h1>T√¨m K√®o & ƒê·∫∑t S√¢n Nhanh Ch√≥ng</h1>
            <form id="playerSearchForm">
                <select id="searchSport" required><option value="">-- Ch·ªçn m√¥n --</option></select>
                <input type="date" id="searchDate" required>
                <input type="time" id="searchTime" required>
                <input type="number" id="searchDuration" placeholder="Th·ªùi l∆∞·ª£ng (h)" value="2" step="0.5" style="max-width:120px">
                <button type="submit" class="btn-success">üîç T√¨m S√¢n Ngay</button>
            </form>
        </header>

        <div class="container">
            <div class="tab-nav">
                <button class="tab-btn active" id="btn-tab-matches" onclick="openTab('tab-matches')">üèüÔ∏è Tr·∫≠n ƒê·∫•u</button>
                <button class="tab-btn" id="btn-tab-search" onclick="openTab('tab-search')">üîç K·∫øt Qu·∫£ T√¨m Ki·∫øm</button>
                <button class="tab-btn" id="btn-tab-owner" onclick="openTab('tab-owner')">üõ†Ô∏è Qu·∫£n L√Ω S√¢n</button>
                <button class="tab-btn" id="btn-tab-profile" onclick="openTab('tab-profile')">üë§ H·ªì S∆° C√° Nh√¢n</button>
            </div>

            <div id="tab-matches" class="tab-content active">
                <div class="sub-tabs">
                    <div class="sub-tab-btn active" onclick="loadMatches('open', this)">üî• K√®o Th∆°m (ƒêang m·ªü)</div>
                    <div class="sub-tab-btn" onclick="loadMatches('mine', this)">üìÖ L·ªãch C·ªßa T√¥i</div>
                </div>
                <div id="matches-list-container"><p style="text-align:center; color:var(--text-light)">ƒêang t·∫£i d·ªØ li·ªáu...</p></div>
            </div>

            <div id="tab-search" class="tab-content">
                <h3>K·∫øt qu·∫£ t√¨m s√¢n tr·ªëng</h3>
                <div id="search-results-list">
                    <div style="text-align:center; padding:40px; color:var(--text-light)">
                        <div style="font-size:40px; margin-bottom:10px">üîç</div>
                        H√£y nh·∫≠p th√¥ng tin t√¨m ki·∫øm ·ªü tr√™n ƒë·ªÉ t√¨m s√¢n ph√π h·ª£p...
                    </div>
                </div>
            </div>

            <div id="tab-profile" class="tab-content">
                <div class="card" style="max-width:700px; margin:0 auto">
                    <h3>Th√¥ng tin c√° nh√¢n</h3>
                    <form id="profileForm">
                        <div class="grid-2">
                            <div><label>H·ªç ƒë·ªám</label><input type="text" id="pFirstName"></div>
                            <div><label>T√™n</label><input type="text" id="pLastName"></div>
                        </div>
                        <label>T√™n hi·ªÉn th·ªã</label><input type="text" id="pName">
                        <label>S·ªë ƒëi·ªán tho·∫°i</label><input type="text" id="pPhone">
                        <label>Gi·ªõi thi·ªáu</label><textarea id="pBio" rows="3"></textarea>
                        <button type="submit" class="btn-primary">L∆∞u Thay ƒê·ªïi</button>
                    </form>
                </div>
            </div>

            <div id="tab-owner" class="tab-content">
                <div class="grid-2">
                    <div class="card">
                        <h3>1. T·∫°o Khu S√¢n (Venue)</h3>
                        <form id="venueForm">
                            <label>T√™n khu s√¢n</label><input type="text" id="vName" placeholder="VD: S√¢n C·∫ßu L√¥ng A" required>
                            <label>ƒê·ªãa ch·ªâ</label><input type="text" id="vAddr" placeholder="ƒê·ªãa ch·ªâ chi ti·∫øt" required>
                            <button type="submit" class="btn-primary btn-block">+ T·∫°o Khu M·ªõi</button>
                        </form>
                    </div>
                    <div class="card">
                        <h3>2. Th√™m S√¢n Con (Court)</h3>
                        <button onclick="loadVenues()" style="background:#f3f4f6; color:#374151; width:100%; margin-bottom:15px">üîÑ T·∫£i Danh S√°ch Khu</button>
                        <div id="owner-venues-list" style="max-height:200px; overflow-y:auto; margin-bottom:15px; border:1px solid var(--border); border-radius:8px;"></div>
                        
                        <div id="court-form-wrapper" style="display:none; border-top:1px dashed var(--border); padding-top:15px; background:#f9fafb; padding:15px; border-radius:8px;">
                            <h5 style="margin:0 0 15px 0; color:var(--primary)">Th√™m s√¢n v√†o: <span id="selectedVenueName"></span></h5>
                            <form id="courtForm">
                                <label>T√™n s√¢n con</label><input type="text" id="cName" placeholder="VD: S√¢n s·ªë 1" required>
                                <label>Gi√° ti·ªÅn / gi·ªù</label><input type="number" id="cPrice" placeholder="VNƒê" required>
                                <label>M√¥n th·ªÉ thao</label><select id="cSport" required><option value="">-- Ch·ªçn m√¥n --</option></select>
                                <button type="submit" class="btn-success btn-block" style="margin-top:10px">+ Th√™m S√¢n</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3>3. Duy·ªát Y√™u C·∫ßu ƒê·∫∑t S√¢n</h3>
                    <button onclick="loadPendingBookings()" style="background:#fef3c7; color:#92400e; margin-bottom:15px">üîÑ T·∫£i Y√™u C·∫ßu M·ªõi</button>
                    <div id="pending-bookings-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="createMatchModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 style="color:var(--primary); margin-top:0; text-align:center">T·∫°o Tr·∫≠n ƒê·∫•u M·ªõi</h2>
            <div id="modalCourtInfo" class="modal-info"></div>
            
            <form id="createMatchForm">
                <label>Ti√™u ƒë·ªÅ tr·∫≠n ƒë·∫•u</label>
                <input type="text" id="mTitle" placeholder="VD: Giao l∆∞u vui v·∫ª s√°ng T7" required>
                
                <label>M√¥ t·∫£ chi ti·∫øt</label>
                <textarea id="mDesc" rows="3" placeholder="VD: C·∫ßn t√¨m 2 b·∫°n tr√¨nh ƒë·ªô trung b√¨nh, ti·ªÅn s√¢n chia ƒë·ªÅu..."></textarea>
                
                <div class="grid-2">
                    <div>
                        <label>Tr√¨nh ƒë·ªô y√™u c·∫ßu</label>
                        <select id="mSkill">
                            <option value="all">M·ªçi tr√¨nh ƒë·ªô</option>
                            <option value="beginner">M·ªõi ch∆°i</option>
                            <option value="intermediate">Trung b√¨nh</option>
                            <option value="advanced">N√¢ng cao</option>
                        </select>
                    </div>
                    <div>
                        <label>S·ªë ng∆∞·ªùi t·ªëi ƒëa</label>
                        <input type="number" id="mMax" value="4" min="2" required>
                    </div>
                </div>
                
                <input type="hidden" id="hCourtId"><input type="hidden" id="hOwnerId">
                <input type="hidden" id="hPrice"><input type="hidden" id="hSportId">
                <input type="hidden" id="hDate"><input type="hidden" id="hTime"><input type="hidden" id="hDur">
                
                <button type="submit" class="btn-success btn-block" style="margin-top:10px; padding:15px">‚úÖ X√°c Nh·∫≠n & ƒê·∫∑t S√¢n</button>
            </form>
        </div>
    </div>

    <div id="messageArea"></div>

    <script>
        // üõë C·∫§U H√åNH URL API
        const API = "https://cnpm-ub8a.onrender.com"; 
        let sportsList = [];

        /* --- UI HELPER FUNCTIONS --- */
        function showMsg(text, isError=false) {
            const el = document.getElementById('messageArea');
            el.textContent = text; 
            el.style.background = isError ? 'var(--red)' : 'var(--green)';
            el.style.display = 'block'; 
            setTimeout(() => el.style.display = 'none', 3000);
        }
        function toggleAuth() {
            const log = document.getElementById('login-card');
            const reg = document.getElementById('register-card');
            if(log.style.display==='none') { log.style.display='block'; reg.style.display='none'; }
            else { log.style.display='none'; reg.style.display='block'; }
        }
        function openTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const btn = document.getElementById('btn-'+id); 
            if(btn) btn.classList.add('active');
        }
        function getUser() { return JSON.parse(localStorage.getItem('user')); }
        
        async function api(url, method='GET', body=null) {
            const opts = { method, headers: {} };
            if(body) { opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(body); }
            const res = await fetch(API + url, opts);
            const data = await res.json();
            if(!res.ok) throw new Error(data.error || 'L·ªói k·∫øt n·ªëi server');
            return data;
        }

        /* --- AUTHENTICATION --- */
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = await api('/api/auth/login', 'POST', {
                    email: document.getElementById('loginEmail').value, password: document.getElementById('loginPassword').value
                });
                localStorage.setItem('user', JSON.stringify(data)); initApp(data);
            } catch(err) { showMsg(err.message, true); }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await api('/api/auth/register', 'POST', {
                    display_name: document.getElementById('regName').value, email: document.getElementById('regEmail').value,
                    password: document.getElementById('regPassword').value, role: document.getElementById('regRole').value
                });
                showMsg("ƒêƒÉng k√Ω th√†nh c√¥ng!"); toggleAuth();
            } catch(err) { showMsg(err.message, true); }
        });

        /* --- APP INITIALIZATION --- */
        function initApp(user) {
            document.getElementById('auth-container').style.display='none';
            document.getElementById('app-container').style.display='block';
            document.getElementById('welcomeMsg').textContent = `Hi, ${user.display_name}`;
            document.getElementById('searchDate').valueAsDate = new Date();
            
            // Fill Profile Data
            document.getElementById('pName').value = user.display_name || '';
            document.getElementById('pFirstName').value = user.first_name || '';
            document.getElementById('pLastName').value = user.last_name || '';
            document.getElementById('pPhone').value = user.phone_number || '';
            document.getElementById('pBio').value = user.bio || '';

            loadSports();

            // Role-based View
            if(user.role === 'owner') {
                document.getElementById('hero-section').style.display = 'none';
                document.getElementById('btn-tab-matches').style.display = 'none';
                document.getElementById('btn-tab-search').style.display = 'none';
                document.getElementById('btn-tab-owner').style.display = 'block';
                openTab('tab-owner');
            } else {
                document.getElementById('hero-section').style.display = 'block';
                document.getElementById('btn-tab-matches').style.display = 'block';
                document.getElementById('btn-tab-search').style.display = 'block';
                document.getElementById('btn-tab-owner').style.display = 'none';
                openTab('tab-matches');
                loadMatches('open');
            }
        }

        /* --- COMMON DATA --- */
        async function loadSports() {
            try {
                sportsList = await api('/api/sports');
                const opts = '<option value="">-- Ch·ªçn m√¥n --</option>' + sportsList.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
                document.getElementById('searchSport').innerHTML = opts;
                document.getElementById('cSport').innerHTML = opts;
            } catch(e){}
        }
        function getSportName(id) { const s = sportsList.find(x=>x.id==id); return s?s.name:'Th·ªÉ thao'; }

        /* --- OWNER LOGIC --- */
        document.getElementById('venueForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await api('/api/venues', 'POST', { owner_id: getUser().id, name: document.getElementById('vName').value, address: document.getElementById('vAddr').value });
                showMsg("T·∫°o khu s√¢n th√†nh c√¥ng!"); loadVenues(); document.getElementById('venueForm').reset();
            } catch(e) { showMsg(e.message, true); }
        });

        let curVenueId = null;
        async function loadVenues() {
            try {
                const data = await api(`/api/venues/my-venues?owner_id=${getUser().id}`);
                document.getElementById('owner-venues-list').innerHTML = data.map(v => 
                    `<div class="venue-item" onclick="selectVenue(this, ${v.id}, '${v.name}')">
                        <div style="font-weight:600; color:var(--primary)">${v.name}</div>
                        <div style="font-size:13px; color:var(--text-light)">${v.address}</div>
                    </div>`
                ).join('');
            } catch(e){}
        }

        function selectVenue(el, id, name) {
            curVenueId = id;
            document.querySelectorAll('.venue-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('court-form-wrapper').style.display='block';
            document.getElementById('selectedVenueName').innerText=name; 
            loadCourts(id);
        }

        document.getElementById('courtForm').addEventListener('submit', async (e) => {
            e.preventDefault(); if(!curVenueId) return;
            try {
                await api('/api/courts', 'POST', { venue_id: curVenueId, sport_id: document.getElementById('cSport').value, name: document.getElementById('cName').value, price_per_hour: document.getElementById('cPrice').value });
                showMsg("Th√™m s√¢n th√†nh c√¥ng!"); loadCourts(curVenueId);
            } catch(e) { showMsg(e.message, true); }
        });

        async function loadCourts(vid) {
            const data = await api(`/api/courts?venue_id=${vid}`);
            document.getElementById('courts-list').innerHTML = data.map(c => 
                `<div style="padding:8px; border-bottom:1px solid #eee; font-size:14px">
                    <b>${c.name}</b> - ${parseInt(c.price_per_hour).toLocaleString()}ƒë/h 
                    <span style="background:#e0f2fe; padding:2px 6px; border-radius:4px; font-size:12px; margin-left:5px">${getSportName(c.sport_id)}</span>
                </div>`
            ).join('');
        }

        async function loadPendingBookings() {
            const data = await api(`/api/bookings/owner?owner_id=${getUser().id}`);
            document.getElementById('pending-bookings-list').innerHTML = data.length ? data.map(b => `
                <div class="booking-item">
                    <div class="info-col">
                        <h4>${b.title}</h4>
                        <p>S√¢n: <b>${b.court_name}</b></p>
                        <p>Th·ªùi gian: ${new Date(b.start_time).toLocaleString('vi-VN')}</p>
                        <p style="color:var(--primary); font-weight:bold">Ti·ªÅn: ${parseInt(b.total_price).toLocaleString()}ƒë</p>
                    </div>
                    <div class="action-col">
                        <button class="btn-success" onclick="handleBook(${b.id}, 'approve')">Duy·ªát</button>
                        <button class="btn-danger" onclick="handleBook(${b.id}, 'reject')">H·ªßy</button>
                    </div>
                </div>`).join('') : '<p style="text-align:center; color:#999">Kh√¥ng c√≥ y√™u c·∫ßu n√†o.</p>';
        }
        async function handleBook(bid, act) {
            try { await api('/api/bookings/action', 'PUT', { owner_id: getUser().id, booking_id: bid, action: act }); showMsg("ƒê√£ x·ª≠ l√Ω!"); loadPendingBookings(); }
            catch(e) { showMsg(e.message, true); }
        }

        /* --- PLAYER LOGIC --- */
        document.getElementById('playerSearchForm').addEventListener('submit', async (e) => {
            e.preventDefault(); showMsg("ƒêang t√¨m s√¢n...");
            const sid = document.getElementById('searchSport').value;
            const date = document.getElementById('searchDate').value;
            const time = document.getElementById('searchTime').value;
            const dur = parseFloat(document.getElementById('searchDuration').value);
            const start = `${date} ${time}:00`; 
            const d = new Date(`${date}T${time}`);
            d.setHours(d.getHours() + Math.floor(dur)); d.setMinutes(d.getMinutes() + (dur%1)*60);
            const end = d.toISOString().slice(0,19).replace('T',' ');
            const startISO = new Date(start).toISOString().slice(0,19).replace('T',' ');

            try {
                const data = await api(`/api/courts/search?sport_id=${sid}&start=${startISO}&end=${end}`);
                const list = document.getElementById('search-results-list');
                if(data.length===0) { list.innerHTML = '<p style="text-align:center; padding:30px;">Kh√¥ng c√≥ s√¢n tr·ªëng.</p>'; }
                else {
                    list.innerHTML = data.map(c => {
                        const total = c.price_per_hour * dur;
                        const safeName = c.name.replace(/'/g, "\\'");
                        return `<div class="court-result-item">
                            <div class="avatar">üèüÔ∏è</div>
                            <div class="info-col">
                                <h4>${c.name}</h4>
                                <p>${c.venue_name}</p>
                                <p style="color:var(--green); font-weight:bold">${parseInt(c.price_per_hour).toLocaleString()}ƒë/h <span style="color:#666; font-weight:normal">-> T·ªïng: ${total.toLocaleString()}ƒë</span></p>
                            </div>
                            <div class="action-col">
                                <button class="btn-success" onclick="openModal(${c.id}, '${safeName}', ${c.owner_id}, ${total}, ${sid}, '${startISO}', '${end}', ${dur})">ƒê·∫∑t S√¢n</button>
                            </div>
                        </div>`
                    }).join('');
                }
                openTab('tab-search');
            } catch(e) { showMsg(e.message, true); }
        });

        function openModal(cid, cname, oid, total, sid, start, end, dur) {
            document.getElementById('hCourtId').value=cid; document.getElementById('hOwnerId').value=oid;
            document.getElementById('hPrice').value=total; document.getElementById('hSportId').value=sid;
            document.getElementById('hDate').value=start; document.getElementById('hTime').value=end; document.getElementById('hDur').value=dur;
            document.getElementById('modalCourtInfo').innerHTML = `
                <p><strong>S√¢n:</strong> ${cname}</p>
                <p><strong>Th·ªùi gian:</strong> ${start} ‚ûù ${end}</p>
                <p style="font-size:1.1em; color:var(--green); margin-top:5px"><strong>T·ªïng ti·ªÅn: ${total.toLocaleString()} VNƒê</strong></p>
            `;
            document.getElementById('createMatchModal').style.display='flex';
        }
        function closeModal() { document.getElementById('createMatchModal').style.display='none'; }
        window.onclick = function(event) { if (event.target == document.getElementById('createMatchModal')) closeModal(); }

        document.getElementById('createMatchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const user = getUser();
                if(!user) { alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); return; }
                
                await api('/api/matches', 'POST', {
                    creator_id: user.id, sport_id: document.getElementById('hSportId').value,
                    title: document.getElementById('mTitle').value, description: document.getElementById('mDesc').value,
                    skill_level_required: document.getElementById('mSkill').value, max_players: document.getElementById('mMax').value,
                    start_time: document.getElementById('hDate').value, end_time: document.getElementById('hTime').value,
                    court_id: document.getElementById('hCourtId').value, owner_id: document.getElementById('hOwnerId').value,
                    total_price: document.getElementById('hPrice').value
                });

                showMsg("G·ª≠i y√™u c·∫ßu th√†nh c√¥ng! ƒêang chuy·ªÉn ƒë·∫øn l·ªãch...");
                closeModal(); 
                document.getElementById('createMatchForm').reset();
                
                // Auto switch to My Schedule
                openTab('tab-matches');
                const mineBtn = document.querySelectorAll('.sub-tab-btn')[1];
                loadMatches('mine', mineBtn);
                
            } catch(e) { showMsg(e.message, true); }
        });

        async function loadMatches(type, btn) {
            if(btn) { document.querySelectorAll('.sub-tab-btn').forEach(e=>e.classList.remove('active')); btn.classList.add('active'); }
            const list = document.getElementById('matches-list-container'); list.innerHTML='<p style="text-align:center">ƒêang t·∫£i...</p>';
            try {
                const user = getUser();
                const url = type === 'open' ? '/api/matches/open' : `/api/matches/mine?user_id=${user.id}`;
                const data = await api(url);
                if(data.length===0) { list.innerHTML='<p style="text-align:center; padding:20px">Kh√¥ng c√≥ tr·∫≠n ƒë·∫•u n√†o.</p>'; return; }
                
                list.innerHTML = data.map(m => {
                    // Logic hi·ªÉn th·ªã tr·∫°ng th√°i ho·∫∑c n√∫t tham gia
                    let actionHTML = '';
                    if (type === 'open') {
                        actionHTML = `<button class="btn-success" onclick="joinMatch(${m.id})">Tham Gia</button>`;
                    } else {
                        // Logic m√†u s·∫Øc tr·∫°ng th√°i
                        let statusColor = '#f59e0b'; // Cam (Pending)
                        let statusText = '‚è≥ Ch·ªù duy·ªát';
                        if(m.booking_status === 'payment_pending') { statusColor = '#10b981'; statusText = '‚úÖ ƒê√£ duy·ªát / Ch·ªù thanh to√°n'; }
                        else if(m.booking_status === 'confirmed') { statusColor = '#10b981'; statusText = '‚úÖ ƒê√£ c·ªçc'; }
                        else if(m.booking_status === 'rejected') { statusColor = '#ef4444'; statusText = '‚ùå B·ªã t·ª´ ch·ªëi'; }
                        
                        actionHTML = `<span style="font-weight:bold; color:${statusColor}; background:rgba(255,255,255,0.8); padding:5px 10px; border-radius:20px; border:1px solid ${statusColor}">${statusText}</span>`;
                    }

                    return `
                    <div class="match-card">
                        <div class="avatar">‚öΩ</div>
                        <div class="info-col">
                            <h4>${m.title} <span style="font-weight:normal; font-size:12px; color:#666">(${m.sport_name})</span></h4>
                            <p>üìç ${m.venue_name} - ${m.court_name}</p>
                            <p>‚è∞ ${new Date(m.start_time).toLocaleString('vi-VN', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'})}</p>
                            <p>üë§ ${m.current_players}/${m.max_players} ng∆∞·ªùi ch∆°i</p>
                        </div>
                        <div class="action-col">${actionHTML}</div>
                    </div>`;
                }).join('');
            } catch(e) { list.innerHTML='L·ªói t·∫£i d·ªØ li·ªáu'; }
        }

        async function joinMatch(mid) {
            if(!confirm("B·∫°n mu·ªën tham gia tr·∫≠n n√†y?")) return;
            try { await api('/api/matches/join', 'POST', { match_id: mid, user_id: getUser().id }); showMsg("Tham gia th√†nh c√¥ng!"); loadMatches('open'); }
            catch(e) { showMsg(e.message, true); }
        }

        // PROFILE
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const user = getUser();
                const body = { user_id: user.id, display_name: document.getElementById('pName').value, first_name: document.getElementById('pFirstName').value, last_name: document.getElementById('pLastName').value, phone_number: document.getElementById('pPhone').value, bio: document.getElementById('pBio').value };
                await api('/api/profile', 'PUT', body);
                Object.assign(user, body); localStorage.setItem('user', JSON.stringify(user)); showMsg("C·∫≠p nh·∫≠t xong!");
            } catch(e) { showMsg(e.message, true); }
        });

        function logout() { localStorage.removeItem('user'); location.reload(); }
    </script>
</body>
</html>
