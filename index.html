<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vui Th·ªÉ Thao</title>
    
    <style>
        /* === C√ÄI ƒê·∫∂T CHUNG === */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            color: #333;
        }
        * {
            box-sizing: border-box;
        }
        button {
            background-color: #007bff; color: white; border: none;
            padding: 10px 15px; font-size: 14px; border-radius: 5px;
            cursor: pointer; margin-top: 10px; transition: background-color 0.2s;
            font-weight: 600;
        }
        button:hover { background-color: #0056b3; }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* === 1. KHU V·ª∞C AUTH (ƒêƒÇNG NH·∫¨P/ƒêƒÇNG K√ù) === */
        #auth-container {
            display: flex;
            gap: 2rem;
            max-width: 900px;
            margin: 50px auto;
        }
        .form-card {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex: 1;
        }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px; border: 1px solid #ddd;
            border-radius: 5px; box-sizing: border-box; font-family: inherit;
        }
        button.register-btn { background-color: #42b72a; }
        button.register-btn:hover { background-color: #36a420; }
        
        /* === 2. KHU V·ª∞C APP (SAU KHI ƒêƒÇNG NH·∫¨P) === */
        #app-container {
            display: none; /* ·∫®n ban ƒë·∫ßu */
        }
        
        /* === 2.1. Top Nav (Thanh xanh tr√™n c√πng) === */
        .top-nav {
            background-color: #4267B2; /* M√†u xanh Facebook/VuiTheThao */
            color: white;
            padding: 0 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .nav-content {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            height: 56px;
        }
        .logo {
            font-weight: bold;
            font-size: 20px;
            margin-right: 20px;
        }
        .nav-links {
            flex-grow: 1;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            font-weight: 600;
            border-radius: 4px;
        }
        .nav-links a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .nav-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #welcomeMessage {
            font-weight: 600;
        }
        .logout-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0;
        }
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        /* === 2.2. Hero Header (·∫¢nh n·ªÅn v√† T√¨m ki·∫øm) === */
        .hero-header {
            /* B·∫°n c√≥ th·ªÉ thay ·∫£nh n√†y */
            background-image: linear-gradient(rgba(59, 89, 152, 0.85), rgba(59, 89, 152, 0.85)), url('https://images.unsplash.com/photo-1542567431-031e403659e7?q=80');
            background-size: cover;
            background-position: center;
            padding: 50px 20px;
            color: white;
            text-align: center;
        }
        .hero-header h1 {
            font-size: 2.2rem;
            margin: 0 0 30px 0;
        }
        /* Style cho Form T√¨m S√¢n c·ªßa Player */
        #playerSearchForm {
            display: flex;
            flex-wrap: wrap; /* Cho ph√©p xu·ªëng h√†ng tr√™n mobile */
            justify-content: center;
            gap: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
        }
        #playerSearchForm .form-group {
            flex: 1;
            min-width: 150px;
            margin-bottom: 0;
        }
        #playerSearchForm label {
            display: none; /* ·∫®n label */
        }
        #playerSearchForm input, #playerSearchForm select {
            border: none;
            border-radius: 5px;
            padding: 12px;
            width: 100%;
        }
        #playerSearchForm button {
            background-color: #18A4E0; /* M√†u xanh cyan */
            padding: 12px 20px;
            flex-shrink: 0;
            margin: 0;
        }
        #playerSearchForm button:hover {
            background-color: #1593c9;
        }

        /* === 2.3. Sub Nav (Thanh filter) === */
        .sub-nav {
            background-color: #fff;
            padding: 15px 0;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }
        .sub-nav .container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .sub-nav span {
            font-weight: 600;
        }
        .filter-pills a {
            text-decoration: none;
            color: #333;
            background-color: #e4e6eb;
            padding: 8px 12px;
            border-radius: 20px; /* Pills */
            margin: 0 5px;
            font-size: 14px;
        }
        .filter-pills a.active {
            background-color: #007bff;
            color: white;
        }
        
        /* === 2.4. Main Container (Tabs) === */
        .main-container {
            max-width: 1000px;
            margin: 20px auto;
        }
        .tab-nav {
            display: flex;
            background-color: #fff;
            border-radius: 8px 8px 0 0;
            border: 1px solid #ddd;
            padding: 0 10px;
        }
        .tab-button {
            padding: 15px 20px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #555;
            border-bottom: 3px solid transparent;
            margin: 0;
        }
        .tab-button.active {
            border-bottom: 3px solid #007bff;
            color: #007bff;
        }
        .tab-content {
            display: none;
            background: #fff;
            padding: 2rem;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
        }
        .tab-content.active {
            display: block;
        }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        
        /* === 2.5. Style cho K·∫øt qu·∫£ T√¨m S√¢n (Gi·ªëng card) === */
        .search-results {
            margin-top: 1.5rem;
            max-height: 500px;
            overflow-y: auto;
        }
        .court-result-item {
            display: flex;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            gap: 15px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            margin-bottom: 1rem;
        }
        .court-result-item .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #e4e6eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #888;
            flex-shrink: 0;
        }
        .court-result-item .info {
            flex-grow: 1;
        }
        .court-result-item .info h4 {
            margin: 0 0 5px 0;
            color: #4267B2; /* Blue name */
        }
        .court-result-item .info .sport-tags {
            font-size: 12px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }
        .court-result-item .info .bio {
            font-size: 14px;
            color: #333;
        }
        .court-result-item .location {
            flex-shrink: 0;
            width: 150px;
            text-align: right;
            font-size: 14px;
            color: #555;
        }
        button.book-btn {
            background-color: #42b72a;
            width: 100%;
        }
        button.book-btn:hover { background-color: #36a420; }
        
        /* === Th√¥ng b√°o === */
        #messageArea {
            display: none; position: fixed; bottom: 20px; right: 20px;
            max-width: 400px; z-index: 1000; padding: 1rem; border-radius: 5px;
            font-family: 'Courier New', Courier, monospace;
        }
        #messageArea.success { background-color: #d4edda; color: #155724; display: block; }
        #messageArea.error { background-color: #f8d7da; color: #721c24; display: block; }

    </style>
</head>
<body>

    <div id="auth-container">
        <div class="form-card">
            <h2>ƒêƒÉng Nh·∫≠p</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">M·∫≠t kh·∫©u</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit">ƒêƒÉng Nh·∫≠p</button>
            </form>
        </div>
        <div class="form-card">
            <h2>ƒêƒÉng K√Ω</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label for="regName">T√™n hi·ªÉn th·ªã</label>
                    <input type="text" id="regName" required>
                </div>
                <div class="form-group">
                    <label for="regEmail">Email</label>
                    <input type="email" id="regEmail" required>
                </div>
                <div class="form-group">
                    <label for="regPassword">M·∫≠t kh·∫©u</label>
                    <input type="password" id="regPassword" required>
                </div>
                <div class="form-group">
                    <label for="regRole">Vai tr√≤</label>
                    <select id="regRole">
                        <option value="player">Ng∆∞·ªùi ch∆°i (Player)</option>
                        <option value="owner">Ch·ªß s√¢n (Owner)</option>
                    </select>
                </div>
                <button type="submit" class="register-btn">T·∫°o T√†i Kho·∫£n</button>
            </form>
        </div>
    </div>

    <div id="app-container">
        
        <nav class="top-nav">
            <div class="nav-content">
                <div class="logo">VUI TH·ªÇ THAO</div>
                <div class="nav-links">
                    <a href="#" class="active">T√¨m b·∫°n</a>
                    <a href="#">B·∫£n ƒë·ªì</a>
                    <a href="#">Blog</a>
                </div>
                <div class="nav-user">
                    <span id="welcomeMessage"></span>
                    <button id="logoutButton" class="logout-btn">ƒêƒÉng xu·∫•t</button>
                </div>
            </div>
        </nav>
        
        <header class="hero-header" id="player-hero">
            <div class="hero-content">
                <h1>T√¨m S√¢n Tr·ªëng Nhanh Ch√≥ng</h1>
                <form id="playerSearchForm">
                    <div class="form-group">
                        <label for="searchSport">M√¥n</label>
                        <select id="searchSport" required></select>
                    </div>
                    <div class="form-group">
                        <label for="searchDate">Ng√†y</label>
                        <input type="date" id="searchDate" required>
                    </div>
                    <div class="form-group">
                        <label for="searchTime">Gi·ªù</label>
                        <input type="time" id="searchTime" step="1800" required>
                    </div>
                    <div class="form-group">
                        <label for="searchDuration">Th·ªùi l∆∞·ª£ng (gi·ªù)</label>
                        <input type="number" id="searchDuration" value="2" min="1" step="0.5" required>
                    </div>
                    <button type="submit">T√¨m S√¢n</button>
                </form>
            </div>
        </header>

        <nav class="sub-nav">
            <div class="container">
                <span>B·ªô l·ªçc nhanh:</span>
                <div class="filter-pills">
                    <a href="#" class="active">B·∫°n c·∫ßu l√¥ng</a>
                    <a href="#">B·∫°n b√≥ng chuy·ªÅn</a>
                    <a href="#">B·∫°n tennis</a>
                    <a href="#">B·∫°n b√≥ng ƒë√°</a>
                </div>
            </div>
        </nav>
        
        <main class="main-container">
            <nav class="tab-nav">
                <button class="tab-button" data-tab="player-content" id="player-tab" style="display: none;">K·∫øt Qu·∫£ T√¨m S√¢n</button>
                <button class="tab-button" data-tab="owner-content" id="owner-tab" style="display: none;">Qu·∫£n l√Ω S√¢n</button>
                <button class="tab-button active" data-tab="profile-content">H·ªì S∆° C·ªßa T√¥i</button>
            </nav>
            
            <div id="player-content" class="tab-content">
                <h3>K·∫øt qu·∫£ t√¨m s√¢n tr·ªëng:</h3>
                <div id="search-results-list" class="search-results">
                    <p>Vui l√≤ng t√¨m ki·∫øm ·ªü thanh tr√™n ƒë·ªÉ xem k·∫øt qu·∫£.</p>
                </div>
            </div>
            
            <div id="owner-content" class="tab-content">
                <h4>1. T·∫°o Khu S√¢n M·ªõi</h4>
                <form id="venueForm">
                    </form>
                
                <div id="courts-section">
                    <h4>2. Qu·∫£n L√Ω S√¢n</h4>
                    </div>
            </div>

            <div id="profile-content" class="tab-content active">
                <h3>C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n</h3>
                <form id="profileForm">
                    <div class="form-group">
                        <label for="profileName">T√™n hi·ªÉn th·ªã</label>
                        <input type="text" id="profileName">
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="profileFirstName">H·ªç v√† T√™n ƒë·ªám (First Name)</label>
                            <input type="text" id="profileFirstName">
                        </div>
                        <div class="form-group">
                            <label for="profileLastName">T√™n (Last Name)</label>
                            <input type="text" id="profileLastName">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="profilePhone">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="text" id="profilePhone">
                    </div>
                    <div class="form-group">
                        <label for="profileBio">Gi·ªõi thi·ªáu (Bio)</label>
                        <textarea id="profileBio" rows="3"></textarea>
                    </div>
                    <button type="submit" style="width: auto;">L∆∞u thay ƒë·ªïi</button>
                </form>
            </div>
        </main>
        
    </div>

    <div id="messageArea"></div>

    <script>
        // üõë QUAN TR·ªåNG: S·ª¨A URL N√ÄY
        const API_BASE_URL = "https://cnpm-ub8a.onrender.com";

        // === L·∫•y c√°c ph·∫ßn t·ª≠ ===
        const authContainer = document.getElementById("auth-container");
        const appContainer = document.getElementById("app-container");
        
        const loginForm = document.getElementById("loginForm");
        const registerForm = document.getElementById("registerForm");
        const profileForm = document.getElementById("profileForm");
        const playerSearchForm = document.getElementById("playerSearchForm"); // Form t√¨m ki·∫øm M·ªöI
        
        const logoutButton = document.getElementById("logoutButton");
        const welcomeMessage = document.getElementById("welcomeMessage");
        const messageArea = document.getElementById("messageArea");
        
        // Tab elements
        const playerTab = document.getElementById("player-tab");
        const ownerTab = document.getElementById("owner-tab");
        const profileTab = document.querySelector('.tab-button[data-tab="profile-content"]');
        
        // Owner elements
        // (L∆∞u √Ω: B·∫°n c·∫ßn copy HTML c·ªßa Owner tab t·ª´ tin nh·∫Øn tr∆∞·ªõc v√†o ƒë√¢y)
        // const venueForm = ...
        // const courtForm = ...
        
        // Player elements
        const searchSportSelect = document.getElementById("searchSport");
        const searchResultsList = document.getElementById("search-results-list");

        let messageTimer;
        let currentVenueId = null; 
        
        // === H√†m Global ===
        
        function showMessage(message, isError = false) {
            clearTimeout(messageTimer);
            messageArea.textContent = message;
            messageArea.className = isError ? 'error' : 'success';
            messageTimer = setTimeout(() => {
                messageArea.style.display = 'none';
            }, 4000);
        }
        
        async function callApi(endpoint, method = 'GET', body = null) {
            const options = { method: method, headers: {} };
            if (body) {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body);
            }
            
            const response = await fetch(API_BASE_URL + endpoint, options);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || "L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ API");
            }
            return data;
        }
        
        function getCurrentUser() {
            return JSON.parse(localStorage.getItem("currentUser"));
        }

        // --- H√†m X·ª≠ l√Ω Tab ---
        const tabButtons = document.querySelectorAll(".tab-button");
        const tabContents = document.querySelectorAll(".tab-content");
        
        tabButtons.forEach(button => {
            button.addEventListener("click", () => {
                tabButtons.forEach(btn => btn.classList.remove("active"));
                tabContents.forEach(content => content.classList.remove("active"));
                
                button.classList.add("active");
                document.getElementById(button.dataset.tab).classList.add("active");
            });
        });
        
        // --- T·∫£i D·ªØ Li·ªáu Chung ---
        
        async function loadSports() {
            try {
                const sports = await callApi("/api/sports", "GET");
                searchSportSelect.innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>';
                // Gi·∫£ s·ª≠ b·∫°n c√≥ <select id="courtSport"> trong tab Owner
                // const courtSportSelect = document.getElementById("courtSport");
                // if (courtSportSelect) courtSportSelect.innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>';
                
                sports.forEach(sport => {
                    const option1 = new Option(sport.name, sport.id);
                    const option2 = new Option(sport.name, sport.id);
                    searchSportSelect.add(option1);
                    // if (courtSportSelect) courtSportSelect.add(option2);
                });
            } catch (error) {
                showMessage("L·ªói t·∫£i danh s√°ch m√¥n th·ªÉ thao: " + error.message, true);
            }
        }

        // --- H√†m ƒêi·ªÅn Form / Hi·ªÉn th·ªã ---
        
        function populateProfileForm(user) {
            document.getElementById("profileName").value = user.display_name || '';
            document.getElementById("profileFirstName").value = user.first_name || '';
            document.getElementById("profileLastName").value = user.last_name || '';
            document.getElementById("profilePhone").value = user.phone_number || '';
            document.getElementById("profileBio").value = user.bio || '';
        }
        
        // (M·ªöI) Hi·ªÉn th·ªã k·∫øt qu·∫£ t√¨m s√¢n (Style Card)
        function renderSearchResults(courts, duration) {
            searchResultsList.innerHTML = '';
            if (courts.length === 0) {
                searchResultsList.innerHTML = '<p>Kh√¥ng t√¨m th·∫•y s√¢n tr·ªëng n√†o ph√π h·ª£p.</p>';
                return;
            }
            
            const searchParams = {
                sport_id: document.getElementById("searchSport").value,
                date: document.getElementById("searchDate").value,
                time_start: document.getElementById("searchTime").value,
                duration: duration
            };
            
            courts.forEach(court => {
                const courtDiv = document.createElement('div');
                courtDiv.className = 'court-result-item';
                
                const totalPrice = parseFloat(court.price_per_hour) * parseFloat(duration);
                
                courtDiv.innerHTML = `
                    <div class="avatar">üèüÔ∏è</div>
                    <div class="info">
                        <h4>${court.name} (T·∫°i: ${court.venue_name})</h4>
                        <div class="sport-tags">SPORT_ID: ${court.sport_id}</div>
                        <p class="bio">${court.address}</p>
                    </div>
                    <div class="location">
                        <p>Gi√°: ${court.price_per_hour} VND/gi·ªù</p>
                        <p><b>T·ªïng: ${totalPrice.toLocaleString('vi-VN')} VND</b></p>
                        <button class="book-btn" 
                            data-court-id="${court.id}"
                            data-court-name="${court.name}"
                            data-owner-id="${court.owner_id}"
                            data-total-price="${totalPrice}"
                        >T·∫°o Tr·∫≠n & ƒê·∫∑t S√¢n</button>
                    </div>
                `;
                
                // G·∫Øn data t√¨m ki·∫øm v√†o n√∫t
                const button = courtDiv.querySelector('.book-btn');
                button.dataset.searchParams = JSON.stringify(searchParams);
                
                searchResultsList.appendChild(courtDiv);
            });
        }

        // --- Event Handlers (S·ª± ki·ªán) ---
        
        // --- X·ª≠ l√Ω Form ƒêƒÇNG NH·∫¨P ---
        loginForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            showMessage("ƒêang ƒëƒÉng nh·∫≠p...", false);
            try {
                const email = document.getElementById("loginEmail").value;
                const password = document.getElementById("loginPassword").value;
                
                const data = await callApi("/api/auth/login", "POST", { email, password });
                
                showMessage(`Ch√†o m·ª´ng, ${data.display_name}!`, false);
                
                authContainer.style.display = 'none';
                appContainer.style.display = 'block';
                welcomeMessage.textContent = `Ch√†o, ${data.display_name} (Vai tr√≤: ${data.role})`;
                
                populateProfileForm(data);
                localStorage.setItem("currentUser", JSON.stringify(data));
                
                // PH√ÇN VAI TR√í
                if (data.role === 'owner') {
                    ownerTab.style.display = 'block';
                    playerTab.style.display = 'block'; // Owner v·∫´n c√≥ th·ªÉ t√¨m s√¢n
                    document.getElementById('player-hero').style.display = 'none'; // ·∫®n hero search
                    ownerTab.click(); 
                } else {
                    playerTab.style.display = 'block';
                    ownerTab.style.display = 'none';
                    document.getElementById('player-hero').style.display = 'block'; // Hi·ªán hero search
                    playerTab.click();
                }
                
                loadSports();

            } catch (error) {
                showMessage("L·ªói ƒêƒÉng Nh·∫≠p:\n" + error.message, true);
            }
        });

        // --- X·ª≠ l√Ω Form ƒêƒÇNG K√ù (ƒê√£ s·ª≠a) ---
        registerForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            showMessage("ƒêang ƒëƒÉng k√Ω...", false);
            try {
                const body = {
                    display_name: document.getElementById("regName").value,
                    email: document.getElementById("regEmail").value,
                    password: document.getElementById("regPassword").value,
                    role: document.getElementById("regRole").value // L·∫•y vai tr√≤
                };
                
                const data = await callApi("/api/auth/register", "POST", body);
                
                showMessage("T·∫°o t√†i kho·∫£n th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.", false);
                registerForm.reset();
                
            } catch (error) {
                showMessage("L·ªói ƒêƒÉng K√Ω:\n" + error.message, true);
            }
        });
        
        // --- X·ª≠ l√Ω Form C·∫¨P NH·∫¨T PROFILE (ƒê√£ s·ª≠a) ---
        profileForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            showMessage("ƒêang c·∫≠p nh·∫≠t...", false);
            try {
                const user = getCurrentUser();
                if (!user) throw new Error("B·∫°n kh√¥ng ƒëƒÉng nh·∫≠p!");
                
                const newProfileData = {
                    user_id: user.id,
                    display_name: document.getElementById("profileName").value,
                    first_name: document.getElementById("profileFirstName").value,
                    last_name: document.getElementById("profileLastName").value,
                    phone_number: document.getElementById("profilePhone").value,
                    bio: document.getElementById("profileBio").value
                };

                const data = await callApi("/api/profile", "PUT", newProfileData);
                showMessage(data.message, false);
                
                Object.assign(user, newProfileData);
                localStorage.setItem("currentUser", JSON.stringify(user));
                welcomeMessage.textContent = `Ch√†o, ${user.display_name} (Vai tr√≤: ${user.role})`;

            } catch (error) {
                showMessage("L·ªói C·∫≠p Nh·∫≠t:\n" + error.message, true);
            }
        });
        
        // --- (M·ªöI) X·ª≠ l√Ω Form T√åM S√ÇN (PLAYER) ---
        playerSearchForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            showMessage("ƒêang t√¨m s√¢n...", false);
            
            try {
                const sport_id = document.getElementById("searchSport").value;
                const date = document.getElementById("searchDate").value;
                const time_start = document.getElementById("searchTime").value;
                const duration = parseFloat(document.getElementById("searchDuration").value);
                
                const start_datetime = new Date(`${date}T${time_start}`);
                const end_datetime = new Date(start_datetime.getTime() + duration * 60 * 60 * 1000);
                
                const formatDateTime = (dt) => dt.toISOString().slice(0, 19).replace('T', ' ');
                const start_time_sql = formatDateTime(start_datetime);
                const end_time_sql = formatDateTime(end_datetime);
                
                const endpoint = `/api/courts/search?sport_id=${sport_id}&start=${start_time_sql}&end=${end_time_sql}`;
                
                const courts = await callApi(endpoint, "GET");
                
                renderSearchResults(courts, duration);
                playerTab.click(); // T·ª± ƒë·ªông chuy·ªÉn sang tab K·∫øt qu·∫£
                showMessage(`T√¨m th·∫•y ${courts.length} s√¢n tr·ªëng.`, false);
                
            } catch(error) {
                showMessage("L·ªói T√¨m S√¢n:\n" + error.message, true);
            }
        });

        // --- (M·ªöI) X·ª≠ l√Ω T·∫†O TR·∫¨N & ƒê·∫∂T S√ÇN (PLAYER) ---
        searchResultsList.addEventListener("click", async (event) => {
            if (!event.target.classList.contains('book-btn')) return;
            
            const button = event.target;
            const courtName = button.dataset.courtName;
            
            const title = prompt(`B·∫°n ƒëang ƒë·∫∑t s√¢n "${courtName}".\nVui l√≤ng nh·∫≠p Ti√™u ƒë·ªÅ tr·∫≠n ƒë·∫•u:`);
            
            if (!title) {
                showMessage("ƒê√£ h·ªßy ƒë·∫∑t s√¢n.", true);
                return;
            }
            
            showMessage("ƒêang g·ª≠i y√™u c·∫ßu ƒë·∫∑t s√¢n...", false);
            
            try {
                const searchParams = JSON.parse(button.dataset.searchParams);
                const start_datetime = new Date(`${searchParams.date}T${searchParams.time_start}`);
                const end_datetime = new Date(start_datetime.getTime() + parseFloat(searchParams.duration) * 60 * 60 * 1000);
                const formatDateTime = (dt) => dt.toISOString().slice(0, 19).replace('T', ' ');
                
                const body = {
                    creator_id: getCurrentUser().id,
                    sport_id: searchParams.sport_id,
                    title: title,
                    start_time: formatDateTime(start_datetime),
                    end_time: formatDateTime(end_datetime),
                    court_id: button.dataset.courtId,
                    owner_id: button.dataset.ownerId,
                    total_price: button.dataset.totalPrice
                };
                
                const data = await callApi("/api/matches", "POST", body);
                
                showMessage("ƒê√£ g·ª≠i y√™u c·∫ßu ƒë·∫∑t s√¢n th√†nh c√¥ng! ID Booking: " + data.insertId, false);
                searchResultsList.innerHTML = '<p>ƒê√£ g·ª≠i y√™u c·∫ßu th√†nh c√¥ng. Vui l√≤ng t√¨m l·∫°i n·∫øu mu·ªën ƒë·∫∑t s√¢n kh√°c.</p>';
                
            } catch(error) {
                showMessage("L·ªói ƒê·∫∑t S√¢n:\n" + error.message, true);
            }
        });

        // --- X·ª≠ l√Ω ƒêƒÇNG XU·∫§T ---
        logoutButton.addEventListener("click", () => {
            localStorage.removeItem("currentUser");
            authContainer.style.display = 'flex';
            appContainer.style.display = 'none';
            // Reset tab
            profileTab.click();
            showMessage("ƒê√£ ƒëƒÉng xu·∫•t.", false);
        });

        // (L∆∞u √Ω: B·∫°n c·∫ßn t·ª± th√™m l·∫°i c√°c h√†m x·ª≠ l√Ω cho Tab Owner (T·∫°o Venue, T·∫°o Court) t·ª´ tin nh·∫Øn tr∆∞·ªõc)
        
    </script>
</body>
</html>