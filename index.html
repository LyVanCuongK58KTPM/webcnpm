<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vui Th·ªÉ Thao - K·∫øt n·ªëi ƒëam m√™</title>
    <style>
        :root { --primary: #1877f2; --green: #42b72a; --red: #dc3545; --bg: #f0f2f5; --white: #ffffff; --text: #1c1e21; }
        body { font-family: Arial, sans-serif; background: var(--bg); margin: 0; color: var(--text); }
        * { box-sizing: border-box; }
        .container { max-width: 1100px; margin: 0 auto; padding: 0 15px; }
        
        /* UI Components */
        button { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-primary { background: var(--primary); } .btn-success { background: var(--green); } .btn-danger { background: var(--red); }
        .btn-block { width: 100%; }
        
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; font-family: inherit; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* Auth */
        #auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .auth-box { background: white; padding: 30px; width: 100%; max-width: 400px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        
        /* App */
        #app-container { display: none; }
        .top-nav { background: white; padding: 0 20px; height: 60px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 50; }
        .logo { font-size: 24px; font-weight: 800; color: var(--primary); }
        
        .hero-header { background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1542567431-031e403659e7?q=80'); background-size: cover; padding: 40px 20px; text-align: center; color: white; }
        #playerSearchForm { display: flex; flex-wrap: wrap; gap: 10px; background: rgba(255,255,255,0.9); padding: 15px; border-radius: 8px; max-width: 900px; margin: 20px auto 0; justify-content: center; }
        #playerSearchForm input, #playerSearchForm select { margin: 0; flex: 1; min-width: 120px; }
        
        /* Tabs */
        .tab-nav { display: flex; background: white; margin: 20px 0; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: #f0f7ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Lists */
        .match-card, .court-result-item, .booking-item, .venue-item { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .match-card { display: flex; align-items: center; gap: 15px; }
        .avatar { width: 50px; height: 50px; background: #e7f3ff; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; }
        .info-col { flex: 1; }
        .action-col { text-align: right; }

        .sub-tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd; }
        .sub-tab-btn { padding: 10px 20px; cursor: pointer; color: #666; border-bottom: 2px solid transparent; }
        .sub-tab-btn.active { color: var(--primary); border-color: var(--primary); font-weight: bold; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .close { float: right; font-size: 24px; cursor: pointer; }
        .modal-info { background: #e7f3ff; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 0.9em; }
        
        #messageArea { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; color: white; border-radius: 5px; display: none; z-index: 9999; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        
        @media (max-width: 768px) { 
            .grid-2 { grid-template-columns: 1fr; } 
            .match-card { flex-direction: column; align-items: flex-start; }
            .action-col { width: 100%; text-align: left; margin-top: 10px; }
            .tab-nav { flex-wrap: wrap; }
        }
    </style>
</head>
<body>

    <div id="auth-container">
        <div id="login-card" class="auth-box">
            <h2 style="text-align:center; color:var(--primary)">ƒêƒÉng Nh·∫≠p</h2>
            <form id="loginForm">
                <input type="email" id="loginEmail" placeholder="Email" required>
                <input type="password" id="loginPassword" placeholder="M·∫≠t kh·∫©u" required>
                <button type="submit" class="btn-primary btn-block">ƒêƒÉng Nh·∫≠p</button>
            </form>
            <p style="text-align:center; margin-top:15px"><a href="#" onclick="toggleAuth()">Ch∆∞a c√≥ t√†i kho·∫£n?</a></p>
        </div>
        <div id="register-card" class="auth-box" style="display:none">
            <h2 style="text-align:center; color:var(--green)">ƒêƒÉng K√Ω</h2>
            <form id="registerForm">
                <input type="text" id="regName" placeholder="T√™n hi·ªÉn th·ªã" required>
                <input type="email" id="regEmail" placeholder="Email" required>
                <input type="password" id="regPassword" placeholder="M·∫≠t kh·∫©u" required>
                <select id="regRole">
                    <option value="player">Ng∆∞·ªùi ch∆°i</option>
                    <option value="owner">Ch·ªß s√¢n</option>
                </select>
                <button type="submit" class="btn-success btn-block">T·∫°o T√†i Kho·∫£n</button>
            </form>
            <p style="text-align:center; margin-top:15px"><a href="#" onclick="toggleAuth()">ƒê√£ c√≥ t√†i kho·∫£n?</a></p>
        </div>
    </div>

    <div id="app-container" style="display:none">
        <nav class="top-nav">
            <div class="logo">VUI TH·ªÇ THAO</div>
            <div>
                <span id="welcomeMsg" style="margin-right:10px; font-weight:bold"></span>
                <button onclick="logout()" style="background:#eee; color:#333">Tho√°t</button>
            </div>
        </nav>

        <header class="hero-header" id="hero-section">
            <h1>T√¨m K√®o & ƒê·∫∑t S√¢n</h1>
            <form id="playerSearchForm">
                <select id="searchSport" required><option value="">-- Ch·ªçn m√¥n --</option></select>
                <input type="date" id="searchDate" required>
                <input type="time" id="searchTime" required>
                <input type="number" id="searchDuration" placeholder="Gi·ªù" value="2" step="0.5">
                <button type="submit" class="btn-primary" style="background:#18A4E0">üîç T√¨m S√¢n</button>
            </form>
        </header>

        <div class="container">
            <div class="tab-nav">
                <button class="tab-btn active" id="btn-tab-matches" onclick="openTab('tab-matches')">üèüÔ∏è Danh S√°ch Tr·∫≠n</button>
                <button class="tab-btn" id="btn-tab-search" onclick="openTab('tab-search')">üîç K·∫øt Qu·∫£ T√¨m</button>
                <button class="tab-btn" id="btn-tab-owner" onclick="openTab('tab-owner')">üõ†Ô∏è Qu·∫£n L√Ω S√¢n</button>
                <button class="tab-btn" id="btn-tab-profile" onclick="openTab('tab-profile')">üë§ H·ªì S∆°</button>
            </div>

            <div id="tab-matches" class="tab-content active">
                <div class="sub-tabs">
                    <div class="sub-tab-btn active" onclick="loadMatches('open', this)">üî• K√®o Th∆°m (ƒêang m·ªü)</div>
                    <div class="sub-tab-btn" onclick="loadMatches('mine', this)">üìÖ L·ªãch C·ªßa T√¥i</div>
                </div>
                <div id="matches-list-container"><p>ƒêang t·∫£i...</p></div>
            </div>

            <div id="tab-search" class="tab-content">
                <h3>K·∫øt qu·∫£ t√¨m s√¢n tr·ªëng</h3>
                <div id="search-results-list"><p style="color:#777">H√£y nh·∫≠p th√¥ng tin t√¨m ki·∫øm ·ªü tr√™n...</p></div>
            </div>

            <div id="tab-profile" class="tab-content">
                <div class="card">
                    <h3>C·∫≠p nh·∫≠t th√¥ng tin</h3>
                    <form id="profileForm">
                        <div class="grid-2">
                            <input type="text" id="pFirstName" placeholder="H·ªç ƒë·ªám">
                            <input type="text" id="pLastName" placeholder="T√™n">
                        </div>
                        <input type="text" id="pName" placeholder="T√™n hi·ªÉn th·ªã">
                        <input type="text" id="pPhone" placeholder="S·ªë ƒëi·ªán tho·∫°i">
                        <textarea id="pBio" rows="3" placeholder="Gi·ªõi thi·ªáu b·∫£n th√¢n..."></textarea>
                        <button type="submit" class="btn-primary">L∆∞u Thay ƒê·ªïi</button>
                    </form>
                </div>
            </div>

            <div id="tab-owner" class="tab-content">
                <div class="grid-2">
                    <div class="card">
                        <h4>1. T·∫°o Khu S√¢n</h4>
                        <form id="venueForm">
                            <input type="text" id="vName" placeholder="T√™n khu s√¢n" required>
                            <input type="text" id="vAddr" placeholder="ƒê·ªãa ch·ªâ" required>
                            <button type="submit" class="btn-primary" style="width:100%">+ T·∫°o Khu</button>
                        </form>
                    </div>
                    <div class="card">
                        <h4>2. Th√™m S√¢n Con</h4>
                        <button onclick="loadVenues()" style="background:#eee; color:#333; width:100%; margin-bottom:10px">üîÑ T·∫£i DS Khu</button>
                        <div id="owner-venues-list" style="max-height:150px; overflow-y:auto; margin-bottom:10px"></div>
                        
                        <div id="court-form-wrapper" style="display:none; border-top:1px dashed #ccc; padding-top:10px">
                            <h5>Th√™m v√†o: <span id="selectedVenueName" style="color:var(--primary)"></span></h5>
                            <form id="courtForm">
                                <input type="text" id="cName" placeholder="T√™n s√¢n (S√¢n 1)" required>
                                <input type="number" id="cPrice" placeholder="Gi√°/gi·ªù" required>
                                <select id="cSport" required><option value="">-- Ch·ªçn m√¥n --</option></select>
                                <button type="submit" class="btn-success" style="width:100%">+ Th√™m S√¢n</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h4>3. Duy·ªát Y√™u C·∫ßu</h4>
                    <button onclick="loadPendingBookings()" style="background:#ffc107; color:#333">üîÑ T·∫£i Y√™u C·∫ßu</button>
                    <div id="pending-bookings-list" style="margin-top:15px"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="createMatchModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 style="color:var(--primary); margin-top:0">Th√¥ng Tin Tr·∫≠n ƒê·∫•u</h3>
            <div id="modalCourtInfo" class="modal-info"></div>
            <form id="createMatchForm">
                <label>Ti√™u ƒë·ªÅ tr·∫≠n ƒë·∫•u</label>
                <input type="text" id="mTitle" placeholder="VD: C·∫ßu l√¥ng giao l∆∞u" required>
                <label>M√¥ t·∫£</label>
                <textarea id="mDesc" rows="2" placeholder="Chi ti·∫øt..."></textarea>
                <div class="grid-2">
                    <div><label>Tr√¨nh ƒë·ªô</label><select id="mSkill"><option value="all">M·ªçi tr√¨nh ƒë·ªô</option><option value="beginner">M·ªõi ch∆°i</option><option value="intermediate">Trung b√¨nh</option><option value="advanced">N√¢ng cao</option></select></div>
                    <div><label>S·ªë ng∆∞·ªùi</label><input type="number" id="mMax" value="4" min="2"></div>
                </div>
                <input type="hidden" id="hCourtId"><input type="hidden" id="hOwnerId">
                <input type="hidden" id="hPrice"><input type="hidden" id="hSportId">
                <input type="hidden" id="hDate"><input type="hidden" id="hTime"><input type="hidden" id="hDur">
                <button type="submit" class="btn-success btn-block">‚úÖ X√°c Nh·∫≠n & ƒê·∫∑t S√¢n</button>
            </form>
        </div>
    </div>

    <div id="messageArea"></div>

    <script>
        // üõë S·ª¨A URL N√ÄY
        const API = "https://cnpm-ub8a.onrender.com"; 
        let sportsList = [];

        // CORE
        function showMsg(text, isError=false) {
            const el = document.getElementById('messageArea');
            el.textContent = text; el.style.background = isError ? 'var(--red)' : 'var(--green)';
            el.style.display = 'block'; setTimeout(() => el.style.display = 'none', 3000);
        }
        function toggleAuth() {
            const log = document.getElementById('login-card');
            const reg = document.getElementById('register-card');
            if(log.style.display==='none') { log.style.display='block'; reg.style.display='none'; }
            else { log.style.display='none'; reg.style.display='block'; }
        }
        function openTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const btn = document.getElementById('btn-'+id); if(btn) btn.classList.add('active');
        }
        function getUser() { return JSON.parse(localStorage.getItem('user')); }
        async function api(url, method='GET', body=null) {
            const opts = { method, headers: {} };
            if(body) { opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(body); }
            const res = await fetch(API + url, opts);
            const data = await res.json();
            if(!res.ok) throw new Error(data.error || 'L·ªói API');
            return data;
        }

        // AUTH
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = await api('/api/auth/login', 'POST', {
                    email: document.getElementById('loginEmail').value, password: document.getElementById('loginPassword').value
                });
                localStorage.setItem('user', JSON.stringify(data)); initApp(data);
            } catch(err) { showMsg(err.message, true); }
        });
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await api('/api/auth/register', 'POST', {
                    display_name: document.getElementById('regName').value, email: document.getElementById('regEmail').value,
                    password: document.getElementById('regPassword').value, role: document.getElementById('regRole').value
                });
                showMsg("ƒêƒÉng k√Ω th√†nh c√¥ng!"); toggleAuth();
            } catch(err) { showMsg(err.message, true); }
        });

        function initApp(user) {
            document.getElementById('auth-container').style.display='none';
            document.getElementById('app-container').style.display='block';
            document.getElementById('welcomeMsg').textContent = `Hi, ${user.display_name}`;
            document.getElementById('searchDate').valueAsDate = new Date();
            
            // Profile
            document.getElementById('pName').value = user.display_name || '';
            document.getElementById('pFirstName').value = user.first_name || '';
            document.getElementById('pLastName').value = user.last_name || '';
            document.getElementById('pPhone').value = user.phone_number || '';
            document.getElementById('pBio').value = user.bio || '';
            loadSports();

            if(user.role === 'owner') {
                document.getElementById('hero-section').style.display = 'none';
                document.getElementById('btn-tab-matches').style.display = 'none';
                document.getElementById('btn-tab-search').style.display = 'none';
                document.getElementById('btn-tab-owner').style.display = 'block';
                openTab('tab-owner');
            } else {
                document.getElementById('hero-section').style.display = 'block';
                document.getElementById('btn-tab-matches').style.display = 'block';
                document.getElementById('btn-tab-search').style.display = 'block';
                document.getElementById('btn-tab-owner').style.display = 'none';
                openTab('tab-matches');
                loadMatches('open');
            }
        }

        // DATA
        async function loadSports() {
            try {
                sportsList = await api('/api/sports');
                const opts = '<option value="">-- Ch·ªçn m√¥n --</option>' + sportsList.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
                document.getElementById('searchSport').innerHTML = opts;
                document.getElementById('cSport').innerHTML = opts;
            } catch(e){}
        }
        function getSportName(id) { const s = sportsList.find(x=>x.id==id); return s?s.name:'Th·ªÉ thao'; }

        // OWNER
        document.getElementById('venueForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await api('/api/venues', 'POST', { owner_id: getUser().id, name: document.getElementById('vName').value, address: document.getElementById('vAddr').value });
                showMsg("Th√†nh c√¥ng!"); loadVenues(); document.getElementById('venueForm').reset();
            } catch(e) { showMsg(e.message, true); }
        });
        let curVenueId = null;
        async function loadVenues() {
            const data = await api(`/api/venues/my-venues?owner_id=${getUser().id}`);
            document.getElementById('owner-venues-list').innerHTML = data.map(v => `<div class="venue-item" onclick="selectVenue(${v.id}, '${v.name}')"><b>${v.name}</b><br>${v.address}</div>`).join('');
        }
        function selectVenue(id, name) {
            curVenueId=id; document.getElementById('court-form-wrapper').style.display='block';
            document.getElementById('selectedVenueName').innerText=name; loadCourts(id);
        }
        document.getElementById('courtForm').addEventListener('submit', async (e) => {
            e.preventDefault(); if(!curVenueId) return;
            try {
                await api('/api/courts', 'POST', { venue_id: curVenueId, sport_id: document.getElementById('cSport').value, name: document.getElementById('cName').value, price_per_hour: document.getElementById('cPrice').value });
                showMsg("Th√†nh c√¥ng!"); loadCourts(curVenueId);
            } catch(e) { showMsg(e.message, true); }
        });
        async function loadCourts(vid) {
            const data = await api(`/api/courts?venue_id=${vid}`);
            document.getElementById('courts-list').innerHTML = data.map(c => `<div>- ${c.name} (${parseInt(c.price_per_hour).toLocaleString()}ƒë/h)</div>`).join('');
        }
        async function loadPendingBookings() {
            const data = await api(`/api/bookings/owner?owner_id=${getUser().id}`);
            document.getElementById('pending-bookings-list').innerHTML = data.length ? data.map(b => `
                <div class="booking-item">
                    <div class="info-col"><h4>${b.title}</h4><p>${b.court_name} | ${parseInt(b.total_price).toLocaleString()}ƒë</p></div>
                    <div class="action-col">
                        <button class="btn-success" onclick="handleBook(${b.id}, 'approve')">Duy·ªát</button>
                        <button class="btn-danger" onclick="handleBook(${b.id}, 'reject')">H·ªßy</button>
                    </div>
                </div>`).join('') : '<p>Kh√¥ng c√≥ y√™u c·∫ßu.</p>';
        }
        async function handleBook(bid, act) {
            try { await api('/api/bookings/action', 'PUT', { owner_id: getUser().id, booking_id: bid, action: act }); showMsg("ƒê√£ x·ª≠ l√Ω"); loadPendingBookings(); }
            catch(e) { showMsg(e.message, true); }
        }

        // PLAYER
        document.getElementById('playerSearchForm').addEventListener('submit', async (e) => {
            e.preventDefault(); showMsg("ƒêang t√¨m...");
            const sid = document.getElementById('searchSport').value;
            const date = document.getElementById('searchDate').value;
            const time = document.getElementById('searchTime').value;
            const dur = parseFloat(document.getElementById('searchDuration').value);
            const start = `${date} ${time}:00`;
            const d = new Date(`${date}T${time}`);
            d.setHours(d.getHours() + Math.floor(dur)); d.setMinutes(d.getMinutes() + (dur%1)*60);
            const end = d.toISOString().slice(0,19).replace('T',' ');
            const startISO = new Date(start).toISOString().slice(0,19).replace('T',' ');

            try {
                const data = await api(`/api/courts/search?sport_id=${sid}&start=${startISO}&end=${end}`);
                const list = document.getElementById('search-results-list');
                list.innerHTML = data.length ? data.map(c => {
                    const total = c.price_per_hour * dur;
                    const safeName = c.name.replace(/'/g, "\\'");
                    return `<div class="court-result-item">
                        <div class="avatar">üèüÔ∏è</div>
                        <div class="info-col"><h4>${c.name}</h4><p>${c.venue_name}</p><p style="color:var(--green); font-weight:bold">T·ªïng: ${total.toLocaleString()}ƒë</p></div>
                        <div class="action-col"><button class="btn-success" onclick="openModal(${c.id}, '${safeName}', ${c.owner_id}, ${total}, ${sid}, '${startISO}', '${end}', ${dur})">ƒê·∫∑t S√¢n</button></div>
                    </div>`
                }).join('') : '<p>Kh√¥ng c√≥ s√¢n tr·ªëng.</p>';
                openTab('tab-search');
            } catch(e) { showMsg(e.message, true); }
        });

        function openModal(cid, cname, oid, total, sid, start, end, dur) {
            document.getElementById('hCourtId').value=cid; document.getElementById('hOwnerId').value=oid;
            document.getElementById('hPrice').value=total; document.getElementById('hSportId').value=sid;
            document.getElementById('hDate').value=start; document.getElementById('hTime').value=end; document.getElementById('hDur').value=dur;
            document.getElementById('modalCourtInfo').innerHTML = `<b>S√¢n:</b> ${cname}<br><b>T·ªïng:</b> ${total.toLocaleString()} VNƒê`;
            document.getElementById('createMatchModal').style.display='flex';
        }
        function closeModal() { document.getElementById('createMatchModal').style.display='none'; }

        document.getElementById('createMatchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const user = getUser();
                if(!user) { alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); return; }
                await api('/api/matches', 'POST', {
                    creator_id: user.id, sport_id: document.getElementById('hSportId').value,
                    title: document.getElementById('mTitle').value, description: document.getElementById('mDesc').value,
                    skill_level_required: document.getElementById('mSkill').value, max_players: document.getElementById('mMax').value,
                    start_time: document.getElementById('hDate').value, end_time: document.getElementById('hTime').value,
                    court_id: document.getElementById('hCourtId').value, owner_id: document.getElementById('hOwnerId').value,
                    total_price: document.getElementById('hPrice').value
                });
                showMsg("G·ª≠i y√™u c·∫ßu th√†nh c√¥ng!"); closeModal(); 
                document.getElementById('search-results-list').innerHTML = '<p style="color:green; text-align:center"><b>ƒê√£ g·ª≠i y√™u c·∫ßu! Xem t·∫°i tab L·ªãch C·ªßa T√¥i.</b></p>';
            } catch(e) { console.error(e); showMsg(e.message, true); }
        });

        async function loadMatches(type, btn) {
            if(btn) { document.querySelectorAll('.sub-tab-btn').forEach(e=>e.classList.remove('active')); btn.classList.add('active'); }
            const list = document.getElementById('matches-list-container'); list.innerHTML='Loading...';
            try {
                const user = getUser();
                const url = type === 'open' ? '/api/matches/open' : `/api/matches/mine?user_id=${user.id}`;
                const data = await api(url);
                list.innerHTML = data.length ? data.map(m => `
                    <div class="match-card">
                        <div class="avatar">‚öΩ</div>
                        <div class="info-col"><h4>${m.title}</h4><p>üìç ${m.venue_name}</p><p>‚è∞ ${new Date(m.start_time).toLocaleString('vi-VN')}</p></div>
                        <div class="action-col">${type === 'open' ? `<button class="btn-success" onclick="joinMatch(${m.id})">Tham Gia</button>` : `<span style="font-weight:bold">${m.booking_status}</span>`}</div>
                    </div>`).join('') : '<p>Kh√¥ng c√≥ tr·∫≠n n√†o.</p>';
            } catch(e) { list.innerHTML='L·ªói t·∫£i'; }
        }

        async function joinMatch(mid) {
            if(!confirm("Tham gia?")) return;
            try { await api('/api/matches/join', 'POST', { match_id: mid, user_id: getUser().id }); showMsg("Th√†nh c√¥ng!"); loadMatches('open'); }
            catch(e) { showMsg(e.message, true); }
        }

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const user = getUser();
                const body = { user_id: user.id, display_name: document.getElementById('pName').value, first_name: document.getElementById('pFirstName').value, last_name: document.getElementById('pLastName').value, phone_number: document.getElementById('pPhone').value, bio: document.getElementById('pBio').value };
                await api('/api/profile', 'PUT', body);
                Object.assign(user, body); localStorage.setItem('user', JSON.stringify(user)); showMsg("C·∫≠p nh·∫≠t xong!");
            } catch(e) { showMsg(e.message, true); }
        });
        function logout() { localStorage.removeItem('user'); location.reload(); }
    </script>
</body>
</html>
