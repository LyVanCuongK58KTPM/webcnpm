<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vui Th·ªÉ Thao - N·ªÅn T·∫£ng K·∫øt N·ªëi Th·ªÉ Thao</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           1. CORE STYLES & VARIABLES
           ========================================= */
        :root {
            --primary: #2563eb;       /* Xanh ch·ªß ƒë·∫°o */
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #10b981;       /* Xanh l√° (Duy·ªát/Th√†nh c√¥ng) */
            --warning: #f59e0b;       /* Cam (Ch·ªù duy·ªát) */
            --danger: #ef4444;        /* ƒê·ªè (H·ªßy/L·ªói) */
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-light: #64748b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; font-size: 14px; line-height: 1.5; }
        
        /* =========================================
           2. UI COMPONENTS
           ========================================= */
        /* Buttons */
        button {
            padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer;
            font-weight: 600; font-size: 14px; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px;
        }
        button:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .w-100 { width: 100%; }

        /* Inputs */
        input, select, textarea {
            width: 100%; padding: 10px 12px; border: 1px solid var(--border);
            border-radius: 8px; background: white; color: var(--text-main);
            margin-bottom: 12px; font-family: inherit;
        }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-main); }

        /* Layout */
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid var(--border); }
        
        /* Typography & Badges */
        h2, h3, h4 { margin-top: 0; color: var(--text-main); }
        .text-muted { color: var(--text-light); font-size: 0.9em; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .badge-pending { background: #fef3c7; color: #b45309; }
        .badge-payment { background: #dbeafe; color: #1e40af; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-rejected { background: #fee2e2; color: #991b1b; }

        /* =========================================
           3. AUTHENTICATION SCREEN
           ========================================= */
        #auth-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #eff6ff 0%, #fff 100%); }
        .auth-box { width: 100%; max-width: 400px; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .auth-header { text-align: center; margin-bottom: 30px; }
        .auth-logo { font-size: 32px; font-weight: 800; color: var(--primary); display: block; margin-bottom: 10px; }

        /* =========================================
           4. MAIN APPLICATION
           ========================================= */
        #app-screen { display: none; }
        
        /* Header */
        .header { background: white; height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 50; }
        .brand { font-size: 20px; font-weight: 800; color: var(--primary); }
        .user-info { display: flex; align-items: center; gap: 15px; font-weight: 500; }

        /* Hero Search (Player) */
        .hero-section { background: linear-gradient(rgba(30, 58, 138, 0.9), rgba(30, 58, 138, 0.8)), url('https://images.unsplash.com/photo-1542567431-031e403659e7?q=80'); background-size: cover; padding: 60px 20px; text-align: center; color: white; border-radius: 0 0 24px 24px; margin-bottom: 30px; }
        .search-bar { background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; max-width: 900px; margin: 20px auto 0; display: flex; flex-wrap: wrap; gap: 10px; border: 1px solid rgba(255,255,255,0.2); }
        .search-bar input, .search-bar select { margin: 0; border: none; flex: 1; min-width: 140px; }

        /* Tabs Navigation */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .nav-tab { padding: 10px 20px; background: white; border-radius: 8px; color: var(--text-light); cursor: pointer; white-space: nowrap; border: 1px solid var(--border); transition: 0.2s; font-weight: 500; }
        .nav-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* Tab Content Area */
        .tab-pane { display: none; animation: fadeIn 0.3s ease; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Lists Items (Venue, Court, Match) */
        .list-item { display: flex; align-items: center; gap: 15px; padding: 15px; border-bottom: 1px solid var(--border); }
        .list-item:last-child { border-bottom: none; }
        .list-icon { width: 48px; height: 48px; background: #eff6ff; color: var(--primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
        .list-content { flex: 1; }
        .list-title { font-weight: 600; font-size: 15px; margin-bottom: 4px; color: var(--text-main); }
        .list-actions { display: flex; gap: 8px; }

        /* =========================================
           5. MODALS & TOASTS
           ========================================= */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 16px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .toast { position: fixed; bottom: 30px; right: 30px; padding: 12px 24px; background: #333; color: white; border-radius: 8px; display: none; z-index: 9999; font-weight: 500; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
            .list-item { flex-direction: column; align-items: flex-start; }
            .list-actions { width: 100%; justify-content: flex-end; margin-top: 10px; }
        }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div id="login-box" class="auth-box">
            <div class="auth-header">
                <span class="auth-logo">Vui Th·ªÉ Thao</span>
                <p class="text-muted">ƒêƒÉng nh·∫≠p ƒë·ªÉ qu·∫£n l√Ω s√¢n ho·∫∑c t√¨m k√®o</p>
            </div>
            <form id="loginForm">
                <label>Email</label>
                <input type="email" id="lEmail" placeholder="admin@san.com" required>
                <label>M·∫≠t kh·∫©u</label>
                <input type="password" id="lPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                <button type="submit" class="btn-primary w-100">ƒêƒÉng Nh·∫≠p</button>
            </form>
            <div style="text-align:center; margin-top:20px">
                <span class="text-muted">Ch∆∞a c√≥ t√†i kho·∫£n? </span>
                <a href="#" onclick="switchAuth('register')" style="color:var(--primary); font-weight:600; text-decoration:none">ƒêƒÉng k√Ω ngay</a>
            </div>
        </div>

        <div id="register-box" class="auth-box" style="display:none">
            <div class="auth-header">
                <span class="auth-logo">T·∫°o T√†i Kho·∫£n</span>
            </div>
            <form id="regForm">
                <label>H·ªç v√† T√™n</label>
                <input type="text" id="rName" placeholder="Nguy·ªÖn VƒÉn A" required>
                <label>Email</label>
                <input type="email" id="rEmail" placeholder="email@vidu.com" required>
                <label>M·∫≠t kh·∫©u</label>
                <input type="password" id="rPass" required>
                <label>Vai tr√≤</label>
                <select id="rRole">
                    <option value="player">Ng∆∞·ªùi ch∆°i (T√¨m s√¢n)</option>
                    <option value="owner">Ch·ªß s√¢n (Qu·∫£n l√Ω)</option>
                </select>
                <button type="submit" class="btn-success w-100">ƒêƒÉng K√Ω</button>
            </form>
            <div style="text-align:center; margin-top:20px">
                <a href="#" onclick="switchAuth('login')" style="color:var(--primary); font-weight:600; text-decoration:none">Quay l·∫°i ƒêƒÉng nh·∫≠p</a>
            </div>
        </div>
    </div>

    <div id="app-screen">
        <header class="header">
            <div class="brand">VUI TH·ªÇ THAO</div>
            <div class="user-info">
                <span id="user-display-name">User</span>
                <button onclick="logout()" class="btn-outline btn-sm">ƒêƒÉng xu·∫•t</button>
            </div>
        </header>

        <div id="hero-section" class="hero-section">
            <h1>T√¨m K√®o & ƒê·∫∑t S√¢n Nhanh Ch√≥ng</h1>
            <p>H√†ng trƒÉm s√¢n c·∫ßu l√¥ng, b√≥ng ƒë√° ƒëang ch·ªù b·∫°n</p>
            <form id="searchForm" class="search-bar">
                <select id="sSport" required><option>ƒêang t·∫£i m√¥n...</option></select>
                <input type="date" id="sDate" required>
                <input type="time" id="sTime" required>
                <input type="number" id="sDur" value="2" min="1" step="0.5" placeholder="Gi·ªù">
                <button type="submit" class="btn-success">üîç T√¨m S√¢n</button>
            </form>
        </div>

        <div class="container">
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="setTab('tab-profile')">üë§ H·ªì S∆°</div>
                <div id="menu-player" style="display:contents">
                    <div class="nav-tab" onclick="setTab('tab-matches')">üèüÔ∏è Danh S√°ch Tr·∫≠n</div>
                    <div class="nav-tab" onclick="setTab('tab-search-res')">üîç K·∫øt Qu·∫£ T√¨m</div>
                </div>
                <div id="menu-owner" style="display:contents">
                    <div class="nav-tab" onclick="setTab('tab-venue')">üè¢ Qu·∫£n L√Ω S√¢n</div>
                    <div class="nav-tab" onclick="setTab('tab-booking')">üìù Duy·ªát ƒê∆°n</div>
                </div>
            </div>

            <div id="tab-profile" class="tab-pane active">
                <div class="card">
                    <h3>Th√¥ng tin c√° nh√¢n</h3>
                    <form id="profileForm">
                        <div class="grid-2">
                            <div><label>H·ªç ƒë·ªám</label><input type="text" id="pFirst"></div>
                            <div><label>T√™n</label><input type="text" id="pLast"></div>
                        </div>
                        <label>T√™n hi·ªÉn th·ªã</label><input type="text" id="pDisplayName">
                        <label>S·ªë ƒëi·ªán tho·∫°i</label><input type="text" id="pPhone">
                        <label>Gi·ªõi thi·ªáu</label><textarea id="pBio" rows="3"></textarea>
                        <button type="submit" class="btn-primary">C·∫≠p nh·∫≠t h·ªì s∆°</button>
                    </form>
                </div>
            </div>

            <div id="tab-matches" class="tab-pane">
                <div class="card">
                    <div style="display:flex; gap:10px; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px">
                        <button onclick="loadMatches('open')" class="btn-sm btn-primary">üî• K√®o Th∆°m (Join ngay)</button>
                        <button onclick="loadMatches('mine')" class="btn-sm btn-outline">üìÖ L·ªãch C·ªßa T√¥i</button>
                    </div>
                    <div id="match-list-container">ƒêang t·∫£i...</div>
                </div>
            </div>

            <div id="tab-search-res" class="tab-pane">
                <div class="card">
                    <h3>K·∫øt qu·∫£ t√¨m s√¢n tr·ªëng</h3>
                    <div id="search-results">
                        <p class="text-muted" style="text-align:center; padding:30px">Vui l√≤ng s·ª≠ d·ª•ng thanh t√¨m ki·∫øm ·ªü tr√™n ƒë·∫ßu trang.</p>
                    </div>
                </div>
            </div>

            <div id="tab-venue" class="tab-pane">
                <div class="grid-2">
                    <div class="card">
                        <h3>T·∫°o Khu S√¢n M·ªõi</h3>
                        <form id="venueForm">
                            <label>T√™n Khu</label><input type="text" id="vName" required>
                            <label>ƒê·ªãa ch·ªâ</label><input type="text" id="vAddr" required>
                            <div class="grid-2">
                                <div><label>M·ªü c·ª≠a</label><input type="time" id="vOpen" value="06:00"></div>
                                <div><label>ƒê√≥ng c·ª≠a</label><input type="time" id="vClose" value="22:00"></div>
                            </div>
                            <button type="submit" class="btn-primary w-100">T·∫°o Khu S√¢n</button>
                        </form>
                    </div>
                    <div class="card">
                        <h3>Th√™m S√¢n Con</h3>
                        <button onclick="loadVenues()" class="btn-outline w-100 mb-3">üîÑ T·∫£i Danh S√°ch Khu</button>
                        <div id="venue-list" style="max-height:200px; overflow-y:auto; margin-bottom:15px"></div>
                        
                        <div id="add-court-box" style="display:none; border-top:1px dashed #ddd; padding-top:15px">
                            <h4 style="font-size:14px; color:var(--primary)">Th√™m s√¢n v√†o: <span id="lblVenueName"></span></h4>
                            <form id="courtForm">
                                <input type="text" id="cName" placeholder="T√™n s√¢n (VD: S√¢n 1)" required>
                                <input type="number" id="cPrice" placeholder="Gi√°/gi·ªù" required>
                                <select id="cSport" required></select>
                                <button type="submit" class="btn-success w-100">Th√™m S√¢n</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-booking" class="tab-pane">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                        <h3>Duy·ªát Y√™u C·∫ßu ƒê·∫∑t S√¢n</h3>
                        <button onclick="loadPendingBookings()" class="btn-sm btn-outline">L√†m m·ªõi</button>
                    </div>
                    <div id="pending-list"></div>
                </div>
            </div>

        </div>
    </div>

    <div id="bookingModal" class="modal-overlay">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px">
                <h3>T·∫°o Tr·∫≠n & ƒê·∫∑t S√¢n</h3>
                <span style="cursor:pointer; font-size:24px" onclick="closeModal()">√ó</span>
            </div>
            
            <div class="alert" style="background:#eff6ff; color:#1d4ed8; padding:10px; border-radius:8px; margin-bottom:15px; font-size:13px">
                <div id="modal-info"></div>
            </div>

            <form id="createMatchForm">
                <label>Ti√™u ƒë·ªÅ tr·∫≠n ƒë·∫•u</label>
                <input type="text" id="mTitle" placeholder="VD: K√®o giao l∆∞u vui v·∫ª" required>
                
                <label>M√¥ t·∫£ (Kh√¥ng b·∫Øt bu·ªôc)</label>
                <textarea id="mDesc" rows="2"></textarea>

                <div class="grid-2">
                    <div>
                        <label>Tr√¨nh ƒë·ªô</label>
                        <select id="mSkill">
                            <option value="all">M·ªçi tr√¨nh ƒë·ªô</option>
                            <option value="beginner">M·ªõi ch∆°i</option>
                            <option value="intermediate">Trung b√¨nh</option>
                            <option value="advanced">N√¢ng cao</option>
                        </select>
                    </div>
                    <div>
                        <label>S·ªë ng∆∞·ªùi t·ªëi ƒëa</label>
                        <input type="number" id="mMax" value="4" required>
                    </div>
                </div>

                <input type="hidden" id="hCourtId"><input type="hidden" id="hOwnerId">
                <input type="hidden" id="hPrice"><input type="hidden" id="hSportId">
                <input type="hidden" id="hStart"><input type="hidden" id="hEnd">

                <button type="submit" class="btn-success w-100">‚úÖ X√°c Nh·∫≠n ƒê·∫∑t S√¢n</button>
            </form>
        </div>
    </div>

    <div id="toast">Th√¥ng b√°o ·ªü ƒë√¢y</div>

    <script>
        // üõë C·∫§U H√åNH API (Thay b·∫±ng link Render c·ªßa b·∫°n)
        const API_URL = "https://cnpm-ub8a.onrender.com/api"; 

        let currentUser = null;
        let sportsCache = [];
        let selectedVenueId = null;

        // === UTILS ===
        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.backgroundColor = type === 'error' ? 'var(--danger)' : 'var(--success)';
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        async function fetchApi(endpoint, method = 'GET', body = null) {
            const headers = { 'Content-Type': 'application/json' };
            const config = { method, headers };
            if (body) config.body = JSON.stringify(body);
            
            try {
                const res = await fetch(API_URL + endpoint, config);
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'L·ªói k·∫øt n·ªëi server');
                return data.data || data; // Support c·∫£ b·ªçc data v√† kh√¥ng b·ªçc
            } catch (err) {
                console.error(err);
                showToast(err.message, 'error');
                throw err;
            }
        }

        // === AUTH LOGIC ===
        function switchAuth(screen) {
            document.getElementById('login-box').style.display = screen === 'login' ? 'block' : 'none';
            document.getElementById('register-box').style.display = screen === 'register' ? 'block' : 'none';
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const user = await fetchApi('/auth/login', 'POST', {
                    email: document.getElementById('lEmail').value,
                    password: document.getElementById('lPass').value
                });
                localStorage.setItem('user', JSON.stringify(user));
                initApp(user);
                showToast('ƒêƒÉng nh·∫≠p th√†nh c√¥ng');
            } catch (e) {}
        });

        document.getElementById('regForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await fetchApi('/auth/register', 'POST', {
                    display_name: document.getElementById('rName').value,
                    email: document.getElementById('rEmail').value,
                    password: document.getElementById('rPass').value,
                    role: document.getElementById('rRole').value
                });
                showToast('ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.');
                switchAuth('login');
            } catch (e) {}
        });

        function logout() {
            localStorage.removeItem('user');
            location.reload();
        }

        // === APP INIT ===
        function initApp(user) {
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
            document.getElementById('user-display-name').textContent = user.display_name;

            // Load Initial Data
            loadSports();
            fillProfile(user);

            // Role Switching
            if (user.role === 'owner') {
                document.getElementById('hero-section').style.display = 'none';
                document.getElementById('menu-player').style.display = 'none';
                document.getElementById('menu-owner').style.display = 'contents';
                setTab('tab-venue'); // Default tab for Owner
            } else {
                document.getElementById('hero-section').style.display = 'block';
                document.getElementById('menu-player').style.display = 'contents';
                document.getElementById('menu-owner').style.display = 'none';
                setTab('tab-matches'); // Default tab for Player
                loadMatches('open');
                
                // Set default date
                document.getElementById('sDate').valueAsDate = new Date();
            }
        }

        function setTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            // Highlight logic (simple lookup)
            const tabIndex = ['tab-profile', 'tab-matches', 'tab-search-res', 'tab-venue', 'tab-booking'].indexOf(tabId);
            // Note: This highlighting logic is basic, improved by adding IDs to nav-tabs if needed
        }

        // === DATA LOADING ===
        async function loadSports() {
            try {
                sportsCache = await fetchApi('/sports');
                const options = '<option value="">-- Ch·ªçn m√¥n --</option>' + 
                    sportsCache.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                document.getElementById('sSport').innerHTML = options;
                document.getElementById('cSport').innerHTML = options; // Owner form
            } catch (e) {}
        }

        function getSportName(id) {
            const s = sportsCache.find(x => x.id == id);
            return s ? s.name : 'Th·ªÉ thao';
        }

        // === PROFILE ===
        function fillProfile(user) {
            document.getElementById('pFirst').value = user.first_name || '';
            document.getElementById('pLast').value = user.last_name || '';
            document.getElementById('pDisplayName').value = user.display_name || '';
            document.getElementById('pPhone').value = user.phone_number || '';
            document.getElementById('pBio').value = user.bio || '';
        }

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const body = {
                user_id: currentUser.id,
                first_name: document.getElementById('pFirst').value,
                last_name: document.getElementById('pLast').value,
                display_name: document.getElementById('pDisplayName').value,
                phone_number: document.getElementById('pPhone').value,
                bio: document.getElementById('pBio').value
            };
            try {
                await fetchApi('/profile', 'PUT', body);
                Object.assign(currentUser, body);
                localStorage.setItem('user', JSON.stringify(currentUser));
                document.getElementById('user-display-name').textContent = currentUser.display_name;
                showToast('C·∫≠p nh·∫≠t th√†nh c√¥ng');
            } catch (e) {}
        });

        // === OWNER FEATURES ===
        
        // 1. Create Venue
        document.getElementById('venueForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await fetchApi('/venues', 'POST', {
                    owner_id: currentUser.id,
                    name: document.getElementById('vName').value,
                    address: document.getElementById('vAddr').value,
                    open_time: document.getElementById('vOpen').value,
                    close_time: document.getElementById('vClose').value
                });
                showToast('T·∫°o khu s√¢n th√†nh c√¥ng');
                document.getElementById('venueForm').reset();
                loadVenues();
            } catch (e) {}
        });

        // 2. Create Court
        async function loadVenues() {
            try {
                const venues = await fetchApi(`/venues/my-venues?owner_id=${currentUser.id}`);
                const html = venues.map(v => `
                    <div class="list-item" style="cursor:pointer" onclick="selectVenue(${v.id}, '${v.name}')">
                        <div class="list-icon">üè¢</div>
                        <div class="list-content">
                            <div class="list-title">${v.name}</div>
                            <div class="text-muted">${v.address}</div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('venue-list').innerHTML = html || '<p>Ch∆∞a c√≥ khu s√¢n n√†o.</p>';
            } catch (e) {}
        }

        function selectVenue(id, name) {
            selectedVenueId = id;
            document.getElementById('add-court-box').style.display = 'block';
            document.getElementById('lblVenueName').textContent = name;
        }

        document.getElementById('courtForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await fetchApi('/courts', 'POST', {
                    venue_id: selectedVenueId,
                    name: document.getElementById('cName').value,
                    price_per_hour: document.getElementById('cPrice').value,
                    sport_id: document.getElementById('cSport').value
                });
                showToast('Th√™m s√¢n th√†nh c√¥ng');
                document.getElementById('courtForm').reset();
            } catch (e) {}
        });

        // 3. Manage Bookings
        async function loadPendingBookings() {
            try {
                const list = await fetchApi(`/bookings/owner?owner_id=${currentUser.id}`);
                const html = list.length ? list.map(b => `
                    <div class="list-item">
                        <div class="list-content">
                            <div class="list-title">${b.title}</div>
                            <div class="text-muted">S√¢n: ${b.court_name}</div>
                            <div class="text-muted">
                                ${new Date(b.start_time).toLocaleString('vi-VN')}
                                <br>üí∞ ${parseInt(b.total_price).toLocaleString()}ƒë
                            </div>
                        </div>
                        <div class="list-actions">
                            <button class="btn-success btn-sm" onclick="bookingAction(${b.id}, 'approve')">Duy·ªát</button>
                            <button class="btn-danger btn-sm" onclick="bookingAction(${b.id}, 'reject')">H·ªßy</button>
                        </div>
                    </div>
                `).join('') : '<p class="text-muted">Kh√¥ng c√≥ y√™u c·∫ßu n√†o.</p>';
                document.getElementById('pending-list').innerHTML = html;
            } catch (e) {}
        }

        async function bookingAction(id, action) {
            try {
                await fetchApi('/bookings/action', 'PUT', {
                    owner_id: currentUser.id,
                    booking_id: id,
                    action: action
                });
                showToast('ƒê√£ x·ª≠ l√Ω');
                loadPendingBookings();
            } catch (e) {}
        }

        // === PLAYER FEATURES ===

        // 1. Search Courts
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const sid = document.getElementById('sSport').value;
            const date = document.getElementById('sDate').value;
            const time = document.getElementById('sTime').value;
            const dur = parseFloat(document.getElementById('sDur').value);

            const start = `${date} ${time}:00`;
            const d = new Date(start);
            d.setHours(d.getHours() + Math.floor(dur));
            d.setMinutes(d.getMinutes() + (dur % 1) * 60);
            
            // Format ISO string manually to ensure local time is respected or use simple string concat for SQL
            // Here keeping it simple:
            const end = d.toISOString().slice(0, 19).replace('T', ' ');
            const startISO = new Date(start).toISOString().slice(0, 19).replace('T', ' ');

            try {
                const courts = await fetchApi(`/courts/search?sport_id=${sid}&start=${startISO}&end=${end}`);
                const html = courts.length ? courts.map(c => {
                    const total = c.price_per_hour * dur;
                    return `
                    <div class="list-item">
                        <div class="list-icon">üèüÔ∏è</div>
                        <div class="list-content">
                            <div class="list-title">${c.name}</div>
                            <div class="text-muted">${c.venue_name}</div>
                            <div style="color:var(--success); font-weight:600">${parseInt(c.price_per_hour).toLocaleString()}ƒë/h</div>
                        </div>
                        <button class="btn-primary btn-sm" 
                            onclick="openBookingModal(${c.id}, '${c.name}', ${c.owner_id}, ${total}, '${startISO}', '${end}', ${sid})">
                            ƒê·∫∑t S√¢n
                        </button>
                    </div>`;
                }).join('') : '<p class="text-muted" style="text-align:center">Kh√¥ng t√¨m th·∫•y s√¢n tr·ªëng.</p>';
                
                document.getElementById('search-results').innerHTML = html;
                setTab('tab-search-res');
            } catch (e) {}
        });

        // 2. Booking Modal
        function openBookingModal(cid, cname, oid, total, start, end, sid) {
            // Set hidden fields
            document.getElementById('hCourtId').value = cid;
            document.getElementById('hOwnerId').value = oid;
            document.getElementById('hPrice').value = total;
            document.getElementById('hStart').value = start;
            document.getElementById('hEnd').value = end;
            document.getElementById('hSportId').value = sid;

            // Show Info
            document.getElementById('modal-info').innerHTML = `
                <b>S√¢n:</b> ${cname}<br>
                <b>Gi·ªù:</b> ${new Date(start).toLocaleString('vi-VN')} <br>
                <b>T·ªïng ti·ªÅn:</b> ${total.toLocaleString()} VNƒê
            `;
            
            document.getElementById('bookingModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('bookingModal').style.display = 'none';
        }

        document.getElementById('createMatchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await fetchApi('/matches', 'POST', {
                    creator_id: currentUser.id,
                    sport_id: document.getElementById('hSportId').value,
                    title: document.getElementById('mTitle').value,
                    description: document.getElementById('mDesc').value,
                    skill_level_required: document.getElementById('mSkill').value,
                    max_players: document.getElementById('mMax').value,
                    start_time: document.getElementById('hStart').value,
                    end_time: document.getElementById('hEnd').value,
                    court_id: document.getElementById('hCourtId').value,
                    owner_id: document.getElementById('hOwnerId').value,
                    total_price: document.getElementById('hPrice').value
                });
                showToast('T·∫°o tr·∫≠n th√†nh c√¥ng!');
                closeModal();
                loadMatches('mine');
                setTab('tab-matches');
            } catch (e) {}
        });

        // 3. Match List & Actions
        async function loadMatches(type) {
            try {
                const url = type === 'open' ? '/matches/open' : `/matches/mine?user_id=${currentUser.id}`;
                const matches = await fetchApi(url);
                const container = document.getElementById('match-list-container');
                
                if (!matches.length) {
                    container.innerHTML = '<p class="text-muted">Kh√¥ng c√≥ tr·∫≠n ƒë·∫•u n√†o.</p>';
                    return;
                }

                container.innerHTML = matches.map(m => {
                    let actionBtn = '';
                    let statusBadge = '';

                    if (type === 'open') {
                        actionBtn = `<button class="btn-success btn-sm" onclick="joinMatch(${m.id})">Tham Gia</button>`;
                    } else {
                        // Status Logic
                        if (m.booking_status === 'pending') statusBadge = '<span class="badge badge-pending">Ch·ªù duy·ªát</span>';
                        else if (m.booking_status === 'payment_pending') {
                            statusBadge = '<span class="badge badge-payment">Ch·ªù thanh to√°n</span>';
                            actionBtn = `<button class="btn-primary btn-sm" onclick="pay(${m.booking_id}, ${m.total_price})">Thanh To√°n</button>`;
                        } else if (m.booking_status === 'confirmed') {
                            statusBadge = '<span class="badge badge-success">ƒê√£ c·ªçc</span>';
                            actionBtn = `<button class="btn-outline btn-sm" onclick="review(${m.booking_id}, ${m.court_id})">ƒê√°nh gi√°</button>`;
                        } else {
                            statusBadge = '<span class="badge badge-rejected">T·ª´ ch·ªëi</span>';
                        }
                    }

                    return `
                    <div class="list-item">
                        <div class="list-icon">‚öΩ</div>
                        <div class="list-content">
                            <div class="list-title">${m.title} <span class="text-muted">(${m.sport_name})</span></div>
                            <div class="text-muted">üìç ${m.venue_name} - ${m.court_name}</div>
                            <div class="text-muted">‚è∞ ${new Date(m.start_time).toLocaleString('vi-VN')}</div>
                            <div class="text-muted">üë§ ${m.current_players}/${m.max_players} ng∆∞·ªùi</div>
                            ${statusBadge}
                        </div>
                        <div class="list-actions">
                            ${actionBtn}
                        </div>
                    </div>`;
                }).join('');
            } catch (e) {}
        }

        async function joinMatch(mid) {
            if(!confirm('B·∫°n mu·ªën tham gia tr·∫≠n n√†y?')) return;
            try {
                await fetchApi('/matches/join', 'POST', { match_id: mid, user_id: currentUser.id });
                showToast('Tham gia th√†nh c√¥ng');
                loadMatches('open');
            } catch(e) {}
        }

        async function pay(bid, amount) {
            if(!confirm(`X√°c nh·∫≠n chuy·ªÉn kho·∫£n ${amount.toLocaleString()}ƒë?`)) return;
            try {
                await fetchApi('/payment', 'POST', { booking_id: bid, user_id: currentUser.id, amount });
                showToast('Thanh to√°n th√†nh c√¥ng');
                loadMatches('mine');
            } catch(e) {}
        }

        async function review(bid, cid) {
            const rating = prompt("ƒê√°nh gi√° (1-5 sao):");
            const comment = prompt("Nh·∫≠n x√©t:");
            if(rating) {
                try {
                    await fetchApi('/reviews', 'POST', { booking_id: bid, user_id: currentUser.id, court_id: cid, rating, comment });
                    showToast('C·∫£m ∆°n b·∫°n!');
                } catch(e) {}
            }
        }

        // Auto Init
        if(localStorage.getItem('user')) {
            initApp(JSON.parse(localStorage.getItem('user')));
        }
    </script>
</body>
</html>
